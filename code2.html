<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Embroidery Size Checker ‚Äì Full Upgraded Features</title>
  <!-- NEW: Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- NEW: jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- NEW: Chart.js for Visual Size Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- NEW: PapaParse for Bulk Import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- NEW: PWA Manifest (inline for single file) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRW1icm9pZGVyeSBDaGVja2VyIiwiY29sb3IiOiIjNjViN2ZmIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK2Jhc2U2NCxzdmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121923; --muted:#8ca0b6; --text:#e6edf3; --accent:#65b7ff; --accent-secondary:#2ecc71; --chip:#1b2430;
      --ok:#2ecc71; --danger:#ff6b6b; --warn:#f39c12;
      --radius:16px; --radius-sm:10px;
    }
    /* NEW: Light mode vars */
    :root.light {
      --bg:#f8f9fa; --panel:#ffffff; --muted:#6c757d; --text:#212529; --accent:#0d6efd; --chip:#e9ecef;
      --ok:#198754; --danger:#dc3545; --warn:#fd7e14;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,var(--bg) 0%, #0e1420 100%); color:var(--text); transition: background 0.3s, color 0.3s; position:relative; overflow-x:hidden;}
    body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle at 20% 50%,rgba(101,183,255,0.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(46,204,113,0.1) 0%,transparent 50%);pointer-events:none;z-index:0;will-change:transform;transform:translateZ(0);opacity:0;transition:opacity 0.5s ease}
    body.loaded::before{opacity:1;animation:float 20s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translate3d(0,0,0) scale(1)}33%{transform:translate3d(30px,-30px,0) scale(1.1)}66%{transform:translate3d(-20px,20px,0) scale(0.9)}}
    :root.light body::before{background-image:radial-gradient(circle at 20% 50%,rgba(99,102,241,0.08) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(139,92,246,0.08) 0%,transparent 50%)}
    header{position:sticky; top:0; background:linear-gradient(135deg,rgba(10,14,20,.85),rgba(15,23,42,.85)); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-bottom:1px solid #1f2a36; z-index:10; box-shadow:0 4px 20px rgba(0,0,0,0.3); will-change:transform,opacity;transform:translateZ(0)}
    header.loaded{animation:slideDown 0.3s ease-out}
    @keyframes slideDown{from{transform:translate3d(0,-20px,0);opacity:0}to{transform:translate3d(0,0,0);opacity:1}}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px}
    h1{margin:0 0 6px; font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:.95rem}
    .panel{background:linear-gradient(135deg,var(--panel),rgba(18,25,35,0.95)); border:1px solid #1f2a36; border-radius:var(--radius); padding:14px; transition: background 0.3s; box-shadow:0 8px 32px rgba(0,0,0,0.4),0 0 0 1px rgba(101,183,255,0.1) inset; position:relative; z-index:1; will-change:transform,opacity;transform:translateZ(0)}
    .panel.loaded{animation:fadeInUp 0.3s ease-out}
    @keyframes fadeInUp{from{transform:translate3d(0,20px,0);opacity:0}to{transform:translate3d(0,0,0);opacity:1}}

    .searchbar{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; position:relative; margin-bottom:15px}
    /* NEW: Enhanced Autocomplete dropdown */
    #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: linear-gradient(135deg,var(--panel),rgba(18,25,35,0.95)); backdrop-filter: blur(20px); border: 1px solid var(--accent); border-radius: var(--radius-sm); max-height: 250px; overflow-y: auto; z-index: 20; display: none; box-shadow:0 8px 32px rgba(0,0,0,0.4); margin-top:5px; animation:slideDown 0.2s ease-out}
    #suggestions div { padding: 12px 16px; cursor: pointer; transition: all 0.2s ease; border-bottom:1px solid rgba(101,183,255,0.1); display:flex; align-items:center; gap:10px}
    #suggestions div:last-child{border-bottom:none}
    #suggestions div:hover { background: linear-gradient(135deg,rgba(101,183,255,0.15),rgba(101,183,255,0.05)); transform:translateX(4px); border-left:3px solid var(--accent)}
    #suggestions div::before{content:'üîç'; opacity:0.6; font-size:0.9rem}
    input[type="text"], input[type="password"]{width:100%; font-size:1.05rem; padding:14px 18px; background:linear-gradient(135deg,#0f1622,#132033); color:var(--text); border:1px solid #233041; border-radius:var(--radius-sm); outline:0; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative}
    input[type="text"]:focus, input[type="password"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(101,183,255,0.2),0 4px 20px rgba(101,183,255,0.1); transform:translateY(-1px); background:linear-gradient(135deg,#132033,#15243a)}
    input[type="text"]::placeholder{color:var(--muted); opacity:0.6}
    /* NEW: Light mode input */
    :root.light input[type="text"], :root.light input[type="password"] { background: #fff; border-color: #ced4da; }
    .btn{padding:10px 12px; background:linear-gradient(135deg,#172538,#1a2f44); color:#eaf6ff; border:1px solid #2b415c; border-radius:var(--radius-sm); cursor:pointer; font-weight:700; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden}
    .btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(101,183,255,0.2);transform:translate(-50%,-50%);transition:width 0.4s ease,height 0.4s ease}
    .btn:hover::before{width:300px;height:300px}
    .btn:hover { transform: scale(1.05) translateY(-2px); box-shadow:0 4px 20px rgba(101,183,255,0.3); border-color:#3e76a8}
    .btn:active{transform:scale(0.98)}
    .btn.ghost{background:#0f1622}
    .btn.warn{background:#2a1f12; border-color:#6b4b14}
    .btn.ok{background:#142a1f; border-color:#1b5f3a}
    /* NEW: Light mode btn */
    :root.light .btn { background: #e9ecef; color: #212529; border-color: #adb5bd; }
    :root.light .btn.ghost { background: #f8f9fa; }

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; animation: fadeIn 0.3s ease-in;}
    .chip{padding:7px 10px; border:1px solid #293648; background:linear-gradient(135deg,var(--chip),rgba(27,36,48,0.9)); color:#cfe4ff; border-radius:999px; font-size:.84rem; cursor:pointer; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden}
    .chip::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(101,183,255,0.2),transparent);will-change:transform;transform:translateZ(0);transition:transform 0.4s ease}
    .chip:hover::before{transform:translate3d(200%,0,0)}
    .chip:hover { transform: scale(1.08) translate3d(0,-2px,0); box-shadow:0 4px 15px rgba(101,183,255,0.3); border-color:#3e76a8}
    .chip.active{background:linear-gradient(135deg,#1a2f44,#2a4a6a); border-color:#65b7ff; box-shadow:0 0 20px rgba(101,183,255,0.4),0 0 0 2px rgba(101,183,255,0.2) inset}

    .controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:15px; padding:12px; background:linear-gradient(135deg,rgba(15,28,45,0.5),rgba(15,23,42,0.5)); border-radius:var(--radius-sm); border:1px solid rgba(101,183,255,0.1)}
    .controls .group{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid #28405a;background:linear-gradient(135deg,#0f1c2d,#132033);border-radius:10px; transition:all 0.3s ease; box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    .controls .group:hover{border-color:var(--accent); box-shadow:0 4px 15px rgba(101,183,255,0.2); transform:translateY(-2px)}
    .controls select, .controls input[type="checkbox"]{background:linear-gradient(135deg,#0f1622,#132033);color:#e6f2ff;border:1px solid #28405a;border-radius:8px;padding:8px 12px; transition:all 0.2s ease; cursor:pointer}
    .controls select:hover, .controls input[type="checkbox"]:hover{border-color:var(--accent); box-shadow:0 0 0 2px rgba(101,183,255,0.1)}
    .controls select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(101,183,255,0.2); outline:none}
    /* NEW: Light mode controls */
    :root.light .controls .group { background: #f8f9fa; border-color: #dee2e6; }
    :root.light .controls select, :root.light .controls input[type="checkbox"] { background: #fff; color: #212529; border-color: #ced4da; }

    /* NEW: History & Favorites section */
    .history { margin-top: 10px; padding: 10px; background: var(--chip); border-radius: var(--radius-sm); }
    .history .chips { justify-content: flex-start; }
    #favorites { margin-top: 10px; }

    .results{margin-top:20px; display:grid; gap:16px; animation: fadeIn 0.4s ease-in;}
    .card{background:linear-gradient(135deg,#0f1622,#132033); border:1px solid #223246; border-radius:var(--radius); padding:18px; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.4),0 0 0 1px rgba(101,183,255,0.05) inset}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent-secondary),transparent);transform:translateX(-100%);transition:transform 0.6s ease; opacity:0.8}
    .card:hover::before{transform:translateX(100%)}
    .card::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 50% 0%,rgba(101,183,255,0.05),transparent);opacity:0;transition:opacity 0.3s ease;pointer-events:none}
    .card:hover::after{opacity:1}
    .card:hover { transform: translateY(-6px) scale(1.01); box-shadow:0 12px 40px rgba(101,183,255,0.25),0 0 0 2px rgba(101,183,255,0.15) inset,0 0 60px rgba(101,183,255,0.1); border-color:#65b7ff}
    .card h3{margin:0 0 6px}
    .meta{color:var(--muted); font-size:.9rem}
    /* NEW: Light mode card */
    :root.light .card { background: #fff; border-color: #dee2e6; }

    .table-wrap{max-height:65vh;overflow:auto;border-radius:12px; border:1px solid #223246; background:linear-gradient(135deg,rgba(15,22,33,0.5),rgba(18,25,35,0.5)); box-shadow:inset 0 2px 10px rgba(0,0,0,0.3)}
    table{width:max-content; min-width:100%; border-collapse:collapse}
    thead{background:linear-gradient(135deg,#132033,#1a2f44); position:sticky; top:0; z-index:10; box-shadow:0 2px 10px rgba(0,0,0,0.3)}
    th, td{padding:12px 14px; text-align:left; border-bottom:1px dashed rgba(101,183,255,0.15); white-space:nowrap; transition: all 0.2s ease}
    th{font-weight:600; color:var(--accent); text-transform:uppercase; font-size:0.85rem; letter-spacing:0.05em; cursor:pointer; position:relative; user-select:none}
    th:hover { background: linear-gradient(135deg,rgba(101,183,255,0.15),rgba(101,183,255,0.05)); transform:scale(1.02)}
    th::after{content:''; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:0; height:0; border-left:4px solid transparent; border-right:4px solid transparent; opacity:0.5}
    th.sort-asc::after{border-bottom:6px solid var(--accent); opacity:1}
    th.sort-desc::after{border-top:6px solid var(--accent); opacity:1}
    td{cursor:default; color:var(--text)}
    tr:hover td{background:rgba(101,183,255,0.08); transform:scale(1.01)}
    .sticky thead th{position:sticky; top:0; z-index:2}
    .dense th,.dense td{padding:6px 8px; font-size:.9rem}
    .pill{display:inline-block; padding:4px 8px; border:1px solid #28405a; border-radius:999px; background:#112036; font-size:.78rem}
    /* NEW: Enhanced Searchable table input */
    .table-search { width: 100%; padding: 8px 12px; background: linear-gradient(135deg,var(--panel),rgba(18,25,35,0.8)); border: 1px solid rgba(101,183,255,0.2); border-radius: var(--radius-sm); margin-bottom: 8px; color:var(--text); transition:all 0.2s ease }
    .table-search:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(101,183,255,0.2); background:linear-gradient(135deg,var(--panel),rgba(18,25,35,0.95))}
    tr:hover { background: linear-gradient(135deg,rgba(101,183,255,0.08),rgba(101,183,255,0.03)); }
    tr.selected{background:linear-gradient(135deg,rgba(101,183,255,0.2),rgba(101,183,255,0.1)); border-left:3px solid var(--accent)}

    /* NEW: Chart canvas */
    #chartCanvas { max-height: 400px; width: 100%; }

    .footer{margin:24px 0 40px; color:#86a1bd; font-size:.85rem; text-align:center; padding:15px; background:linear-gradient(135deg,rgba(101,183,255,0.05),rgba(46,204,113,0.05)); border-radius:var(--radius-sm); border:1px solid rgba(101,183,255,0.1)}
    .kbd{border:1px solid #3a4f6a; background:linear-gradient(135deg,#0c1421,#132033); padding:4px 8px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:all 0.2s ease}
    .kbd:hover{background:linear-gradient(135deg,#132033,#1a2f44); border-color:var(--accent); transform:scale(1.05)}

    /* NEW: Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* NEW: Theme toggle */
    #themeToggle { cursor: pointer; font-size: 1.2rem; padding: 8px; border-radius: 50%; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden; background:rgba(101,183,255,0.1); border:1px solid rgba(101,183,255,0.2)}
    #themeToggle::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(101,183,255,0.3);transform:translate(-50%,-50%);transition:width 0.3s ease,height 0.3s ease}
    #themeToggle:hover::before{width:100%;height:100%}
    #themeToggle:hover { background: rgba(101,183,255,0.2); transform: scale(1.15) rotate(15deg); box-shadow:0 4px 15px rgba(101,183,255,0.4)}
    #themeToggle:active{transform:scale(0.9)}

    /* NEW: Enhanced Progress bar */
    #progress { width: 100%; height: 4px; background: rgba(101,183,255,0.2); margin-top: 10px; overflow: hidden; display: none; border-radius:2px; }
    #progressBar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-secondary)); width: 0%; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden; border-radius:2px}
    #progressBar::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* NEW: Responsive */
    @media (max-width: 768px) {
      .wrap { padding: 10px; }
      .controls { flex-direction: column; }
      .table-wrap { font-size: 0.8rem; }
      .chips { justify-content: flex-start; overflow-x: auto; }
    }

    /* Admin bar */
    .adminbar{margin-top:14px; display:none}
    .adminbar.active{display:block}
    .admin-grid{display:grid; grid-template-columns:1fr; gap:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    textarea{width:100%; min-height:160px; background:#0f1622; color:#e6edf3; border:1px solid #233041; border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    select{background:#0f1622; color:#e6edf3; border:1px solid #233041; border-radius:10px; padding:8px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#163524; color:#a8f0c1; border:1px solid #2a6b46; font-size:.8rem}
    .danger{color:#ff9e9e}
    /* NEW: Admin quick add & bulk import */
    #quickSizes { margin-bottom: 10px; }
    #btnAddRow { background: var(--ok); }
    #importFile { display: none; }
    .file-upload { cursor: pointer; padding: 10px; background: var(--ok); color: white; border-radius: var(--radius-sm); }

    

    /* NEW: Enhanced Chat Functionality Styles - Toggleable, Visible by Default */
    #chatModal {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 350px;
      height: 500px;
      background: var(--panel);
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      z-index: 101;
      flex-direction: column;
      display: flex;
      box-shadow: 0 8px 32px rgba(101, 183, 255, 0.2);
      overflow: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #chatModal.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    #chatTitle {
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent), #4a90e2);
      color: white;
      font-weight: bold;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg);
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      display: flex;
      flex-direction: column;
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      animation: fadeIn 0.3s ease-in;
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #5aa7ff);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.admin {
      align-self: flex-start;
      background: linear-gradient(135deg, var(--ok), #27ae60);
      color: white;
      border-bottom-left-radius: 4px;
    }
    .message .sender {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .message .time {
      font-size: 0.75rem;
      opacity: 0.7;
      align-self: flex-end;
      margin-top: 4px;
    }
    #chatInputContainer {
      display: flex;
      padding: 12px 16px;
      border-top: 1px solid #1f2a36;
      background: var(--panel);
    }
    #chatInput {
      flex: 1;
      padding: 10px 14px;
      background: #0f1622;
      color: var(--text);
      border: 1px solid #233041;
      border-radius: var(--radius-sm);
      outline: none;
      transition: border-color 0.2s;
    }
    #chatInput:focus {
      border-color: var(--accent);
    }
    #sendBtn {
      margin-left: 8px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sendBtn:hover {
      background: #4a90e2;
    }

    /* NEW: Admin Extra Features */
    #adminExtras { display: none; margin-top: 10px; padding: 10px; background: var(--chip); border-radius: var(--radius-sm); }
    .adminbar.active #adminExtras { display: block; }
    #adminExtras .row { justify-content: flex-start; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><i class="fas fa-threaded"></i> Embroidery Size Checker</h1>
      <div class="sub">Type or paste a product name (English). Auto-search enabled. Example: <span class="kbd">Embroidered Shorts for Women</span> <span id="modeBadge"></span>
      <!-- NEW: Theme toggle -->
      <i id="themeToggle" class="fas fa-moon" title="Toggle Dark/Light Mode"></i>
      <!-- NEW: Language select -->
      <select id="langSelect" title="Language">
        <option value="en">EN</option>
        <option value="vi">VI</option>
      </select>
      </div>
    </div>
  </header>
  <main class="wrap">
    <section class="panel">
      <div class="searchbar">
        <input id="q" type="text" placeholder="Type or paste product name..." autocomplete="off" />
        <!-- NEW: Autocomplete dropdown -->
        <div id="suggestions"></div>
        <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn ghost" id="btnPaste" title="Paste from clipboard (Ctrl+V)"><i class="fas fa-clipboard"></i> Paste</button>
          <button class="btn ghost" id="btnClear" title="Clear input"><i class="fas fa-trash"></i> Clear</button>
          <button class="btn ghost" id="btnPrint" title="Print results (Ctrl+P)"><i class="fas fa-print"></i> Print</button>
          <button class="btn ghost" id="btnExport" title="Export to CSV/PDF"><i class="fas fa-download"></i> Export</button>
          <button class="btn ghost" id="btnChart" title="Toggle Chart View"><i class="fas fa-chart-bar"></i> Chart</button>
          <button class="btn ghost" id="btnShare" title="Share result"><i class="fas fa-share-alt"></i> Share</button>
          <button class="btn ghost" id="btnBookmark" title="Bookmark this product"><i class="fas fa-bookmark"></i> Bookmark</button>
        </div>
      </div>
      <!-- NEW: Progress bar -->
      <div id="progress"><div id="progressBar"></div></div>

      <!-- NEW: Enhanced History section -->
      <div class="history" id="history" style="display:none">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
          <div class="sub" style="margin:0;"><i class="fas fa-history"></i> T√¨m ki·∫øm g·∫ßn ƒë√¢y</div>
          <button class="btn ghost" id="btnClearHistory" style="padding:4px 8px; font-size:0.75rem;">X√≥a</button>
        </div>
      </div>

      <div class="chips" id="chips"></div>
      
      <!-- Quick Stats -->
      <div id="quickStats" style="display:none; margin-top:15px; padding:12px; background:linear-gradient(135deg,rgba(101,183,255,0.1),rgba(46,204,113,0.1)); border-radius:var(--radius-sm); border:1px solid rgba(101,183,255,0.2);">
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; text-align:center;">
          <div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--accent);" id="statTotalSizes">0</div>
            <div style="font-size:0.75rem; color:var(--muted);">K√≠ch c·ª°</div>
          </div>
          <div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--accent-secondary);" id="statTotalPositions">0</div>
            <div style="font-size:0.75rem; color:var(--muted);">V·ªã tr√≠</div>
          </div>
          <div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--warn);" id="statMaxHeight">0</div>
            <div style="font-size:0.75rem; color:var(--muted);">Max H (mm)</div>
          </div>
          <div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--ok);" id="statMaxWidth">0</div>
            <div style="font-size:0.75rem; color:var(--muted);">Max W (mm)</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="group">
          <label><input type="checkbox" id="toggleMatrix" checked> <i class="fas fa-table"></i> Matrix view</label>
          <label><input type="checkbox" id="toggleDense"> <i class="fas fa-compress"></i> Dense</label>
          <!-- NEW: Regex mode -->
          <label><input type="checkbox" id="toggleRegex"> Regex mode</label>
        </div>
        <!-- NEW: Advanced filters -->
        <div class="group">
          <select id="filterPos"><option value="">All Positions</option></select>
          <select id="filterSize"><option value="">All Sizes</option></select>
          <select id="filterCost"><option value="">All Costs</option></select>
        </div>
        <div class="group">
          <button class="btn" id="btnLogin" title="Admin login"><i class="fas fa-lock"></i> Admin login</button>
          <button class="btn ghost" id="btnLogout" style="display:none" title="Logout"><i class="fas fa-unlock"></i> Logout</button>
        </div>
      </div>

      <!-- NEW: Enhanced Favorites section -->
      <div id="favorites" style="display:none; margin-top:15px; padding:12px; background:linear-gradient(135deg,rgba(234,179,8,0.1),rgba(234,179,8,0.05)); border-radius:var(--radius-sm); border:1px solid rgba(234,179,8,0.3);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
          <h4 style="margin:0; color:var(--warn);"><i class="fas fa-star"></i> Y√™u th√≠ch</h4>
          <button class="btn ghost" id="btnClearFavs" style="padding:4px 8px; font-size:0.75rem;">X√≥a t·∫•t c·∫£</button>
        </div>
        <div class="chips" id="favChips"></div>
      </div>

      <!-- Admin Console -->
      <div class="adminbar" id="adminBar">
        <div class="card">
          <h3>Admin Console <span class="badge">edit mode</span></h3>
          <div class="admin-grid">
            <div class="row">
              <label>Product: <input id="adminProductName" type="text" placeholder="Exact product name" /></label>
              <select id="adminExisting"></select>
              <button class="btn" id="btnLoad"><i class="fas fa-upload"></i> Load</button>
              <button class="btn ok" id="btnSave"><i class="fas fa-save"></i> Save</button>
              <button class="btn warn" id="btnDelete"><i class="fas fa-trash"></i> Delete</button>
              <!-- NEW: Bulk Import -->
              <label class="file-upload" for="importFile"><i class="fas fa-upload"></i> Import CSV</label>
              <input type="file" id="importFile" accept=".csv" />
            </div>
            <!-- NEW: Quick Add Size with Auto-Suggest -->
            <div id="quickSizes" class="row">
              <select id="quickSizeSelect">
                <option value="">Select Size to Add</option>
                <option value="XS">XS</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
                <option value="2XL">2XL</option>
                <option value="3XL">3XL</option>
                <option value="4XL">4XL</option>
                <option value="5XL">5XL</option>
                <option value="0-3M">0-3M (Baby)</option>
                <option value="Newborn">Newborn</option>
              </select>
              <input id="quickPos" type="text" placeholder="Position (e.g. Middle)" />
              <input id="quickCost" type="text" placeholder="Cost (e.g. 4)" />
              <button class="btn ok" id="btnAddRow">Add Row</button>
              <div id="suggestPreview" class="sub" style="display:none"></div>
            </div>
            <div>
              <textarea id="adminEditor" placeholder="Enter lines: Position | Cost | Size | MaxHeight | MaxWidth
Example:
Middle | 4 | XS | 195 | 275
..."></textarea>
            </div>
            <div class="sub">Hint: Each line = one size row. Same Position+Cost can repeat for multiple sizes. Numbers are in mm. Use Quick Add for new sizes.</div>
          </div>
        </div>

        <!-- NEW: Admin Extra Features Section -->
        <div id="adminExtras">
          <h4><i class="fas fa-cogs"></i> Admin Tools</h4>
          <div class="row">
            <button class="btn ok" id="btnExportAll"><i class="fas fa-download"></i> Export All Data (JSON)</button>
            <button class="btn warn" id="btnClearHistory"><i class="fas fa-history"></i> Clear User History</button>
            <button class="btn warn" id="btnClearFavorites"><i class="fas fa-star"></i> Clear All Favorites</button>
            <button class="btn danger" id="btnResetData"><i class="fas fa-sync-alt"></i> Reset to Seed Data</button>
          </div>
          <div class="sub">Stats: <span id="adminStats"></span> products loaded.</div>
        </div>
      </div>

      <div class="results" id="results"></div>
      <div class="sub" style="margin-top:8px">Tips: <span class="kbd">Ctrl/‚åò+V</span> to paste. Use chips to filter a single size in non-matrix view.</div>
    </section>

    <p class="footer">All measurements in millimetres (mm). Unauthenticated users can only search; editing requires admin login. Upgraded: Charts, Bulk Import, Auto-Suggest, Multi-Lang, PWA.</p>
  </main>



  <!-- NEW: Chat Modal - Toggleable, Visible by Default -->

  <script>
    // ===== Utilities =====
    const mm = (x)=>x;
    const norm = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
    const titleCase = (s)=> (s||'').replace(/\s+/g,' ').trim().replace(/(^|\s)[a-z]/g, m=>m.toUpperCase());
    const debounce=(fn,ms)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms)}};

    function expandSizes(raw){
      if (Array.isArray(raw)) return raw;
      if (!raw || typeof raw !== 'string') return [String(raw||'All')];
      const cleaned = raw.replaceAll('\u00a0',' ').replace(/\s+/g,' ');
      return cleaned.replaceAll(' - ','-').replaceAll(' ‚Äì ','-').replaceAll(',', '-')
        .split(/-|\/|\u2013/).map(s=>s.trim()).filter(Boolean);
    }
    const makeRows = (sizes,h,w)=>expandSizes(sizes).map(sz=>({size:sz||'All', maxH:mm(h), maxW:mm(w)}));

    // ===== Seed Data (built-in) - FULL FROM ORIGINAL =====
    const group_COMMON_TOPS = [
      {position:'Middle', cost:4, rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Chest', cost:3, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],140,140),...makeRows(['L'],150,150),...makeRows(['XL'],150,150),...makeRows(['2XL'],150,150),...makeRows(['3XL'],160,160),...makeRows(['4XL'],170,170),...makeRows(['5XL'],175,175)]},
      {position:'Neck', cost:1, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],135,135),...makeRows(['L'],135,135),...makeRows(['XL'],145,145),...makeRows(['2XL'],145,145),...makeRows(['3XL'],155,155),...makeRows(['4XL'],165,165),...makeRows(['5XL'],170,170)]},
      {position:'Arm', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Arm', cost:6, rows:[...makeRows(['All'],138,78)]},
      {position:'Cuff', cost:8, rows:[...makeRows(['All'],38,78)]},
      {position:'Cuff', cost:9, rows:[...makeRows(['All'],38,78)]},
      {position:'Back', cost:'B', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Pocket', cost:'P', rows:[...makeRows(['All'],38,78)]},
    ];
    const group_LONG_SLEEVE_TEE = [
      {position:'Front', cost:'F', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Chest', cost:3, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],140,140),...makeRows(['L'],150,150),...makeRows(['XL'],150,150),...makeRows(['2XL'],150,150),...makeRows(['3XL'],160,160),...makeRows(['4XL'],170,170),...makeRows(['5XL'],175,175)]},
      {position:'Neck', cost:1, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],135,135),...makeRows(['L'],135,135),...makeRows(['XL'],145,145),...makeRows(['2XL'],145,145),...makeRows(['3XL'],155,155),...makeRows(['4XL'],165,165),...makeRows(['5XL'],170,170)]},
      {position:'Sleeve', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Sleeve', cost:6, rows:[...makeRows(['All'],138,78)]},
    ];
    const group_SLIT_SIDE = [
      {position:'Front', cost:'F', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Slit Side', cost:'E', rows:[...makeRows(['All'],165,165)]},
      {position:'Slit Side', cost:'S', rows:[...makeRows(['All'],165,165)]},
      {position:'Sleeve', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Sleeve', cost:6, rows:[...makeRows(['All'],138,78)]},
    ];

    const SEED = {
      "Embroidered Hoodie": group_COMMON_TOPS,
      "Embroidered T-Shirt": group_COMMON_TOPS,
      "Embroidered Sweatshirt": group_COMMON_TOPS,
      "Polo Shirt": group_COMMON_TOPS,
      "Embroidered T-Shirt Pocket": group_COMMON_TOPS,
      "Women Sweater": group_COMMON_TOPS,
      "Adult Knit Sweater": group_COMMON_TOPS,
      "Floral Embroidery": group_COMMON_TOPS,
      "Applique Bow": group_COMMON_TOPS,
      "Felt Embroidered Sweatshirt": group_COMMON_TOPS,
      "Felt Embroidered Hoodie": group_COMMON_TOPS,
      "Felt Embroidered T-shirt": group_COMMON_TOPS,
      "Embroidered Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Hoodie V-Notch": group_COMMON_TOPS,
      "Embroidered T-shirt V-Notch": group_COMMON_TOPS,
      "Embroidered Applique Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Quarter Zip Pullover Sweatshirt": group_COMMON_TOPS,
      "Embroidered Applique Quater Zip Pullover Sweatshirt": group_COMMON_TOPS,
      "Embroidered Faux Fur Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Sweatshirt MIX": group_COMMON_TOPS,
      "Embroidered Faux Fur T-shirt V-Notch": group_COMMON_TOPS,

      "Embroidered Long-Sleeve T-Shirt": group_LONG_SLEEVE_TEE,

      "Slit Side Glitter Embroidery": group_SLIT_SIDE,
      "Glitter": group_SLIT_SIDE,
      "Hem Cut & Slit Side Glitter Embroidery": group_SLIT_SIDE,
      "Slit Side Embroidery": group_SLIT_SIDE,
      "Glitter Bow": group_SLIT_SIDE,
      "Hem Cut & Slit Side Embroidery": group_SLIT_SIDE,

      "Embroidered Shorts for Women": [
        {position:'1 side', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(78), maxW:mm(137)})),
          ...expandSizes('XL - 2XL-3XL').map(sz=>({size:sz, maxH:mm(198), maxW:mm(198)})),
        ]},
      ],

      "Embroidered Sweatpants Add on": [
        {position:'Thigh', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(73), maxW:mm(98)})),
          ...expandSizes('XL - 2XL').map(sz=>({size:sz, maxH:mm(108), maxW:mm(118)})),
          ...expandSizes('3XL-4XL').map(sz=>({size:sz, maxH:mm(118), maxW:mm(137)})),
        ]},
        {position:'Leg', cost:4, rows:[{size:'All', maxH:mm(160), maxW:mm(87)}]},
      ],

      "Cap": [
        {position:'Front side', cost:'F', rows:[{size:'All', maxH:mm(59), maxW:mm(120)}]},
        {position:'Back side', cost:'B', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Left side', cost:'L', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Right side', cost:'R', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
      ],

      "Embroidery Golf Towel": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(95), maxW:mm(95)}]},
      ],

      "Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Muslin Blanked Embroidered": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Baby Bib Muslin": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Bib Attachment": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Ruffle Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Heirloom Lace Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Ruffle Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Classic Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Heirloom Lace Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Ruffle Edge Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],

      "Baby Onesie": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3M', maxH:mm(78), maxW:mm(137)},
          {size:'6M', maxH:mm(78), maxW:mm(137)},
          {size:'9M', maxH:mm(78), maxW:mm(137)},
          {size:'12M', maxH:mm(150), maxW:mm(150)},
          {size:'18M', maxH:mm(150), maxW:mm(150)},
          {size:'24M', maxH:mm(170), maxW:mm(170)},
        ]},
      ],

      "Embroidered Kids Knit Sweater": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(145), maxW:mm(165)},
          {size:'3-6 months', maxH:mm(145), maxW:mm(165)},
          {size:'9-12 months', maxH:mm(145), maxW:mm(170)},
          {size:'12-18 months', maxH:mm(145), maxW:mm(195)},
          {size:'18-24m or 2T', maxH:mm(145), maxW:mm(195)},
        ]},
      ],

      "Embroidered Baby Girl Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3M', maxH:mm(70), maxW:mm(80)},
          {size:'3-6M', maxH:mm(75), maxW:mm(85)},
          {size:'6-12-18M', maxH:mm(75), maxW:mm(95)},
        ]},
      ],

      "Embroidered Classic Baby Sweater": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3 months', maxH:mm(190), maxW:mm(180)},
          {size:'3-6 months', maxH:mm(190), maxW:mm(180)},
          {size:'6-9 months', maxH:mm(195), maxW:mm(195)},
          {size:'9-12 months', maxH:mm(195), maxW:mm(195)},
          {size:'12-18 months', maxH:mm(195), maxW:mm(195)},
          {size:'18-24 months', maxH:mm(195), maxW:mm(195)},
        ]},
      ],

      "Ruffle Baby Girl Knit Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'Newborn', maxH:mm(118), maxW:mm(148)},
          {size:'0-3 Months', maxH:mm(128), maxW:mm(162)},
          {size:'3-6 Months', maxH:mm(143), maxW:mm(178)},
        ]},
      ],
      
      "Embroidered Baby Boy Knit Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'Newborn', maxH:mm(118), maxW:mm(148)},
          {size:'0-3 Months', maxH:mm(128), maxW:mm(162)},
          {size:'3-6 Months', maxH:mm(143), maxW:mm(178)},
        ]},
      ],

      "Body Suit Embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'Premie', maxH:mm(88), maxW:mm(98)},
          {size:'Newborn', maxH:mm(88), maxW:mm(108)},
          {size:'0-3 months', maxH:mm(88), maxW:mm(118)},
          {size:'3-6 months', maxH:mm(108), maxW:mm(128)},
          {size:'6-12 months', maxH:mm(118), maxW:mm(138)},
          {size:'12-18 months', maxH:mm(128), maxW:mm(148)},
          {size:'18-24 months', maxH:mm(128), maxW:mm(168)},
        ]},
        {position:'Chest', cost:3, rows:[
          {size:'Premie', maxH:mm(33), maxW:mm(33)},
          {size:'Newborn', maxH:mm(33), maxW:mm(33)},
          {size:'0-3 months', maxH:mm(38), maxW:mm(38)},
          {size:'3-6 months', maxH:mm(43), maxW:mm(43)},
          {size:'6-12 months', maxH:mm(43), maxW:mm(48)},
          {size:'12-18 months', maxH:mm(48), maxW:mm(58)},
          {size:'18-24 months', maxH:mm(58), maxW:mm(68)},
        ]},
      ],

      "Baby Wool Bodysuit": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3M', maxH:mm(160), maxW:mm(160)},
          {size:'3-6M', maxH:mm(160), maxW:mm(160)},
          {size:'6-9M', maxH:mm(160), maxW:mm(160)},
          {size:'9-12M', maxH:mm(180), maxW:mm(180)},
          {size:'12-18M', maxH:mm(180), maxW:mm(180)},
          {size:'18-24M', maxH:mm(180), maxW:mm(180)},
        ]},
      ],

      "Embroidered Premium Burp Cloth": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(165), maxW:mm(165)}]},
      ],

      "Denim Jacket": [
        {position:'Back', cost:'B', rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(165), maxW:mm(265)})),
          ...expandSizes('XL - 2XL').map(sz=>({size:sz, maxH:mm(175), maxW:mm(275)})),
          {size:'3Xl', maxH:mm(185), maxW:mm(285)},
          ...expandSizes('4XL-5XL').map(sz=>({size:sz, maxH:mm(195), maxW:mm(295)})),
        ]},
        {position:'Collar', cost:11, rows:[{size:'All', maxH:mm(33), maxW:mm(195)}]},
        {position:'Shoulder', cost:12, rows:[
          ...expandSizes('S-M-L-XL-2XL').map(sz=>({size:sz, maxH:mm(78), maxW:mm(195)})),
          ...expandSizes('3XL-4XL').map(sz=>({size:sz, maxH:mm(58), maxW:mm(245)})),
        ]},
        {position:'Arm', cost:5, rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Arm', cost:6, rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
      ],

      "Embroidered Linen Apron": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(245)}]},
      ],
      "Embroidered Linen Apron With Two Pockets Middle-Pocket": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(245)}]},
        {position:'Pocket', cost:5, rows:[...expandSizes('S - M').map(sz=>({size:sz, maxH:mm(95), maxW:mm(70)})), {size:'L', maxH:mm(125), maxW:mm(70)}]},
        {position:'Pocket', cost:6, rows:[...expandSizes('S - M').map(sz=>({size:sz, maxH:mm(95), maxW:mm(70)})), {size:'L', maxH:mm(125), maxW:mm(70)}]},
      ],

      "Embroidered Sleep Bag": [
        {position:'Middle', cost:4, rows:[
          ...expandSizes('XS - S - M').map(sz=>({size:sz, maxH:mm(70), maxW:mm(130)})),
          ...expandSizes('L - XL').map(sz=>({size:sz, maxH:mm(82), maxW:mm(150)})),
        ]}
      ],

      "Baby Knotted Cap embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(28), maxW:mm(133)},
          {size:'3-6 months', maxH:mm(28), maxW:mm(133)},
          {size:'6-12 months', maxH:mm(28), maxW:mm(133)},
          {size:'12-18 months', maxH:mm(28), maxW:mm(133)},
          {size:'18-24 months', maxH:mm(28), maxW:mm(133)},
        ]},
      ],

      "Baby Bow Embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(28), maxW:mm(133)},
          {size:'3-6 months', maxH:mm(28), maxW:mm(133)},
          {size:'6-12 months', maxH:mm(28), maxW:mm(133)},
          {size:'12-18 months', maxH:mm(28), maxW:mm(133)},
          {size:'18-24 months', maxH:mm(28), maxW:mm(133)},
          {size:'1-2 years', maxH:mm(38), maxW:mm(133)},
          {size:'2-3 years', maxH:mm(38), maxW:mm(133)},
          {size:'3-4 years', maxH:mm(38), maxW:mm(133)},
        ]},
      ],

      "Embroidered Canvas Strap Tote Bag": [
        {position:'Middle', cost:4, rows:[
          {size:'S', maxH:mm(38), maxW:mm(115)},
          {size:'M', maxH:mm(68), maxW:mm(155)},
          {size:'L', maxH:mm(175), maxW:mm(105)},
        ]}
      ],

      "Christmas Stocking": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(78), maxW:mm(135)}]},
      ],

      "Embroidered Dog Bandana Attachment": [
        {position:'Middle', cost:4, rows:[{size:'S', maxH:mm(125), maxW:mm(145)}, {size:'L', maxH:mm(140), maxW:mm(170)}]},
      ],
      "Embroidered Dog Bandana": [
        {position:'Middle', cost:4, rows:[{size:'S', maxH:mm(125), maxW:mm(145)}, {size:'L', maxH:mm(140), maxW:mm(170)}]},
        {position:'1 side', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(195), maxW:mm(295)})),
          ...expandSizes('XL - 2XL -3XL').map(sz=>({size:sz, maxH:mm(250), maxW:mm(325)})),
          ...expandSizes('4XL ƒë·∫øn 5XL').map(sz=>({size:sz, maxH:mm(250), maxW:mm(350)})),
        ]}
      ],

      "Socks Embroider": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(38), maxW:mm(48)}]},
      ],
    };

    // NEW: Suggest Map for Auto-Suggest (derived from SEED)
    const SUGGEST_MAP = {};
    Object.values(SEED).forEach(blocks => {
      blocks.forEach(block => {
        block.rows.forEach(row => {
          const key = `${block.position}_${row.size}`;
          if (!SUGGEST_MAP[key]) SUGGEST_MAP[key] = {h: row.maxH, w: row.maxW};
        });
      });
    });

    // NEW: Language Map (simple hardcode for EN->VI)
    const LANG_MAP = {
      en: {
        title: "Embroidery Size Checker",
        searchPlaceholder: "Type or paste product name...",
        matrixView: "Matrix view",
        dense: "Dense",
        regexMode: "Regex mode",
        allPositions: "All Positions",
        allSizes: "All Sizes",
        allCosts: "All Costs",
        adminLogin: "Admin login",
        logout: "Logout",
        load: "Load",
        save: "Save",
        delete: "Delete",
        importCSV: "Import CSV",
        selectSize: "Select Size to Add",
        position: "Position (e.g. Middle)",
        cost: "Cost (e.g. 4)",
        addRow: "Add Row",
        hint: "Hint: Each line = one size row...",
        tips: "Tips: Ctrl/‚åò+V to paste...",
        footer: "All measurements in millimetres (mm)...",
        recentSearches: "Recent Searches",
        favorites: "Favorites",
        paste: "Paste",
        clear: "Clear",
        print: "Print",
        export: "Export",
        chart: "Chart View",
        favorite: "Favorite",
        unfavorite: "Unfavorite",
        noMatch: "No match found.",
        loginReq: "Login required",
        wrongCred: "Wrong credentials",
        productReq: "Product name required",
        nothingSave: "Nothing to save. Fill some lines.",
        chooseValid: "Choose a valid product",
        saved: "Saved.",
        deleted: "Deleted.",
        duplicateSizes: "Duplicate sizes detected!",
        selectSize: "Select a size",
        clipboardDenied: "Clipboard permission denied. Use Ctrl/‚åò+V.",
        chatPlaceholder: "Type your message...",
        exportAll: "Export All Data",
        clearHistory: "Clear User History",
        clearFavorites: "Clear All Favorites",
        resetData: "Reset to Seed Data",
        stats: "products loaded"
      },
      vi: {
        title: "C√¥ng C·ª• Ki·ªÉm Tra K√≠ch Th∆∞·ªõc Th√™u",
        searchPlaceholder: "Nh·∫≠p ho·∫∑c d√°n t√™n s·∫£n ph·∫©m...",
        matrixView: "Ch·∫ø ƒë·ªô Ma Tr·∫≠n",
        dense: "M·∫≠t ƒê·ªô",
        regexMode: "Ch·∫ø ƒê·ªô Regex",
        allPositions: "T·∫•t C·∫£ V·ªã Tr√≠",
        allSizes: "T·∫•t C·∫£ K√≠ch C·ª°",
        allCosts: "T·∫•t C·∫£ Chi Ph√≠",
        adminLogin: "ƒêƒÉng Nh·∫≠p Admin",
        logout: "ƒêƒÉng Xu·∫•t",
        load: "T·∫£i",
        save: "L∆∞u",
        delete: "X√≥a",
        importCSV: "Nh·∫≠p CSV",
        selectSize: "Ch·ªçn K√≠ch C·ª° ƒê·ªÉ Th√™m",
        position: "V·ªã Tr√≠ (vd. Middle)",
        cost: "Chi Ph√≠ (vd. 4)",
        addRow: "Th√™m H√†ng",
        hint: "G·ª£i √ù: M·ªói d√≤ng = m·ªôt h√†ng k√≠ch c·ª°...",
        tips: "M·∫πo: Ctrl/‚åò+V ƒë·ªÉ d√°n...",
        footer: "T·∫•t c·∫£ ƒëo l∆∞·ªùng t√≠nh b·∫±ng milimet (mm)...",
        recentSearches: "T√¨m Ki·∫øm G·∫ßn ƒê√¢y",
        favorites: "Y√™u Th√≠ch",
        paste: "D√°n",
        clear: "X√≥a",
        print: "In",
        export: "Xu·∫•t",
        chart: "Xem Bi·ªÉu ƒê·ªì",
        favorite: "Y√™u Th√≠ch",
        unfavorite: "B·ªè Y√™u Th√≠ch",
        noMatch: "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.",
        loginReq: "C·∫ßn ƒëƒÉng nh·∫≠p",
        wrongCred: "Th√¥ng tin ƒëƒÉng nh·∫≠p sai",
        productReq: "C·∫ßn t√™n s·∫£n ph·∫©m",
        nothingSave: "Kh√¥ng c√≥ g√¨ ƒë·ªÉ l∆∞u. ƒêi·ªÅn m·ªôt s·ªë d√≤ng.",
        chooseValid: "Ch·ªçn s·∫£n ph·∫©m h·ª£p l·ªá",
        saved: "ƒê√£ l∆∞u.",
        deleted: "ƒê√£ x√≥a.",
        duplicateSizes: "Ph√°t hi·ªán k√≠ch c·ª° tr√πng l·∫∑p!",
        selectSize: "Ch·ªçn k√≠ch c·ª°",
        clipboardDenied: "Quy·ªÅn clipboard b·ªã t·ª´ ch·ªëi. S·ª≠ d·ª•ng Ctrl/‚åò+V.",
        chatPlaceholder: "Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n...",
        exportAll: "Xu·∫•t T·∫•t C·∫£ D·ªØ Li·ªáu",
        clearHistory: "X√≥a L·ªãch S·ª≠ Ng∆∞·ªùi D√πng",
        clearFavorites: "X√≥a T·∫•t C·∫£ Y√™u Th√≠ch",
        resetData: "ƒê·∫∑t L·∫°i D·ªØ Li·ªáu G·ªëc",
        stats: "s·∫£n ph·∫©m ƒë√£ t·∫£i"
      }
    };

    const LS_KEY = 'embroidery_data_v1';
    const LS_ADMIN = 'embroidery_admin_logged';
    // NEW: LS for history, favorites, theme, lang
    const LS_HISTORY = 'embroidery_history';
    const LS_FAVS = 'embroidery_favs';
    const LS_THEME = 'embroidery_theme';
    const LS_LANG = 'embroidery_lang';
    // NEW: LS for chat
    const LS_CHAT = 'embroidery_chat';
    // NEW: LS for user animal name
    const LS_USER_ANIMAL = 'embroidery_user_animal';

    function loadData(){
      const s = localStorage.getItem(LS_KEY);
      try{ return s? JSON.parse(s) : JSON.parse(JSON.stringify(SEED)); }
      catch(e){ console.warn('Bad data in LS, reset.'); return JSON.parse(JSON.stringify(SEED)); }
    }
    function saveData(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

    let DATA = loadData();
    let currentLang = 'en';
    let chartInstance = null;

    // NEW: Random Animal Names
    const ANIMAL_NAMES = ['Lion', 'Elephant', 'Tiger', 'Eagle', 'Shark', 'Wolf', 'Bear', 'Fox', 'Panda', 'Dolphin', 'Owl', 'Cheetah', 'Giraffe', 'Penguin', 'Kangaroo'];

    function getUserAnimalName() {
      let animal = localStorage.getItem(LS_USER_ANIMAL);
      if (!animal) {
        animal = ANIMAL_NAMES[Math.floor(Math.random() * ANIMAL_NAMES.length)];
        localStorage.setItem(LS_USER_ANIMAL, animal);
      }
      return animal;
    }

    // ===== Auth =====
    function isLogged(){ return localStorage.getItem(LS_ADMIN)==='1'; }
    function login(u,p){ if(u==='1' && p==='1'){ localStorage.setItem(LS_ADMIN,'1'); return true;} return false; }
    function logout(){ localStorage.removeItem(LS_ADMIN); }

    // ===== UI Elements =====
    const elQ=document.getElementById('q');
    const elResults=document.getElementById('results');
    const elChips=document.getElementById('chips');
    const elModeBadge=document.getElementById('modeBadge');
    const elSuggestions = document.getElementById('suggestions');
    const elHistory = document.getElementById('history');
    const elFavChips = document.getElementById('favChips');
    const elProgress = document.getElementById('progress');
    const elProgressBar = document.getElementById('progressBar');

    // NEW: Filters
    const elFilterPos = document.getElementById('filterPos');
    const elFilterSize = document.getElementById('filterSize');
    const elFilterCost = document.getElementById('filterCost');

    const elAdminBar=document.getElementById('adminBar');
    const elAdminName=document.getElementById('adminProductName');
    const elAdminExisting=document.getElementById('adminExisting');
    const elAdminEditor=document.getElementById('adminEditor');

    // NEW: Lang
    const elLangSelect = document.getElementById('langSelect');
    function loadLang() {
      currentLang = localStorage.getItem(LS_LANG) || 'en';
      elLangSelect.value = currentLang;
      updateUIText();
    }
    function updateUIText() {
      const texts = LANG_MAP[currentLang];
      document.querySelector('h1').textContent = texts.title;
      elQ.placeholder = texts.searchPlaceholder;
      document.getElementById('chatInput').placeholder = texts.chatPlaceholder;
      // Update admin extras
      document.getElementById('btnExportAll').innerHTML = `<i class="fas fa-download"></i> ${texts.exportAll} (JSON)`;
      document.getElementById('btnClearHistory').innerHTML = `<i class="fas fa-history"></i> ${texts.clearHistory}`;
      document.getElementById('btnClearFavorites').innerHTML = `<i class="fas fa-star"></i> ${texts.clearFavorites}`;
      document.getElementById('btnResetData').innerHTML = `<i class="fas fa-sync-alt"></i> ${texts.resetData}`;
      document.getElementById('adminStats').textContent = `${Object.keys(DATA).length} ${texts.stats}`;
      // Update other elements (add more as needed)
      // e.g. document.getElementById('btnLogin').textContent = texts.adminLogin;
    }
    elLangSelect.addEventListener('change', (e) => {
      currentLang = e.target.value;
      localStorage.setItem(LS_LANG, currentLang);
      updateUIText();
      doSearch(); // Re-render with new lang
    });

    // NEW: Theme
    function loadTheme() {
      const theme = localStorage.getItem(LS_THEME) || 'dark';
      document.documentElement.classList.toggle('light', theme === 'light');
      document.getElementById('themeToggle').className = theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
    }
    document.getElementById('themeToggle').addEventListener('click', () => {
      const isLight = document.documentElement.classList.toggle('light');
      localStorage.setItem(LS_THEME, isLight ? 'light' : 'dark');
      document.getElementById('themeToggle').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    });

    function refreshAuthUI(){
      const logged=isLogged();
      elAdminBar.classList.toggle('active', logged);
      document.getElementById('btnLogout').style.display = logged? 'inline-block':'none';
      document.getElementById('btnLogin').style.display = logged? 'none':'inline-block';
      elModeBadge.innerHTML = logged? '¬∑ <span class="badge">Admin</span>' : '';
      // update product dropdown
      elAdminExisting.innerHTML = Object.keys(DATA).sort((a,b)=>a.localeCompare(b)).map(n=>`<option value="${n}">${n}</option>`).join('');
      loadTheme();
      loadLang();
      updateUIText(); // Update stats on refresh
    }

    // Simple login prompt
    document.getElementById('btnLogin').addEventListener('click',()=>{
      const u = prompt('Username:');
      const p = prompt('Password:');
      if(login(u||'', p||'')) { 
        refreshAuthUI(); 
        alert('Login successful! Welcome, Admin.');
      } else alert('Wrong credentials');
    });
    document.getElementById('btnLogout').addEventListener('click',()=>{ logout(); refreshAuthUI(); });

    // NEW: History & Favorites
    let history = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
    let favorites = JSON.parse(localStorage.getItem(LS_FAVS) || '[]');

    function renderHistory() {
      if (history.length === 0) return elHistory.style.display = 'none';
      elHistory.innerHTML = '<div class="chips">';
      history.slice(0,8).forEach(h => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.innerHTML = `<span style="margin-right:6px;">üïê</span>${h}`;
        chip.addEventListener('click', () => { elQ.value = h; doSearch(); });
        elHistory.querySelector('.chips').appendChild(chip);
      });
      elHistory.querySelector('.chips').innerHTML += '</div>';
      elHistory.style.display = 'block';
    }
    
    document.getElementById('btnClearHistory')?.addEventListener('click', () => {
      if (confirm('X√≥a l·ªãch s·ª≠ t√¨m ki·∫øm?')) {
        history = [];
        localStorage.removeItem(LS_HISTORY);
        renderHistory();
        showToast('ƒê√£ x√≥a l·ªãch s·ª≠', 'success');
      }
    });

    function addToHistory(query) {
      history = history.filter(h => h !== query).slice(0,9);
      history.unshift(query);
      localStorage.setItem(LS_HISTORY, JSON.stringify(history));
      renderHistory();
    }

    function renderFavorites() {
      if (favorites.length === 0) return elFavChips.parentElement.style.display = 'none';
      elFavChips.innerHTML = '';
      favorites.forEach(fav => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.innerHTML = `<span style="margin-right:6px; color:var(--warn);">‚≠ê</span>${fav}`;
        chip.addEventListener('click', () => { elQ.value = fav; doSearch(); });
        elFavChips.appendChild(chip);
      });
      elFavChips.parentElement.style.display = 'block';
    }
    
    document.getElementById('btnClearFavs')?.addEventListener('click', () => {
      if (confirm('X√≥a t·∫•t c·∫£ y√™u th√≠ch?')) {
        favorites = [];
        localStorage.removeItem(LS_FAVS);
        renderFavorites();
        showToast('ƒê√£ x√≥a y√™u th√≠ch', 'success');
      }
    });

    function toggleFavorite(product) {
      const idx = favorites.indexOf(product);
      if (idx > -1) favorites.splice(idx, 1);
      else favorites.unshift(product);
      localStorage.setItem(LS_FAVS, JSON.stringify(favorites));
      renderFavorites();
    }

    // ===== Search / Render =====
    function keyIndex(){ return Object.keys(DATA).map(k=>({key:k, norm:norm(k)})); }

    // NEW: Regex support
    function fuzzyFind(query){
      const n = norm(query); if(!n) return [];
      const idx = keyIndex();
      const isRegex = document.getElementById('toggleRegex').checked;
      let scored;
      if (isRegex) {
        try {
          const regex = new RegExp(query, 'i');
          scored = idx.filter(({key}) => regex.test(key)).map(keyObj => ({key: keyObj.key, score: 100}));
        } catch { scored = []; }
      } else {
        scored = idx.map(({key, norm:kn})=>{
          let score=0;
          if(kn===n) score=100; else if(kn.includes(n)) score=80 - Math.max(0, kn.length-n.length);
          else { const qTokens=n.split(' '), kTokens=kn.split(' '); const overlap=qTokens.filter(t=>kTokens.includes(t)).length; score=overlap*10; }
          return {key, score};
        }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
      }
      return scored.slice(0,8).map(x=>x.key);
    }

    // NEW: Autocomplete
    function renderAutocomplete() {
      const cands = fuzzyFind(elQ.value);
      elSuggestions.innerHTML = cands.slice(0,5).map(cand => `<div onclick="elQ.value='${cand}'; doSearch(); elSuggestions.style.display='none';">${cand}</div>`).join('');
      elSuggestions.style.display = cands.length ? 'block' : 'none';
    }
    elQ.addEventListener('input', (e) => {
      renderAutocomplete();
    });
    document.addEventListener('click', (e) => { if (!elQ.contains(e.target)) elSuggestions.style.display = 'none'; });

    function chipEl(label){
      const c=document.createElement('button'); c.className='chip'; c.textContent=label; c.dataset.size=label;
      c.addEventListener('click',()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active');
        filterRows(label);
      });
      return c;
    }

    function renderChips(sizes){
      elChips.innerHTML=''; if(!sizes.length) return;
      const all=chipEl('All'); all.classList.add('active'); elChips.appendChild(all);
      sizes.sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true})).forEach(s=>elChips.appendChild(chipEl(s)));
    }

    function filterRows(size){
      document.querySelectorAll('tbody tr').forEach(tr=>{ tr.style.display = (size==='All' || tr.dataset.size===size)?'':'none'; });
    }

    // NEW: Advanced filter (simplified)
    function applyFilters() {
      const pos = elFilterPos.value;
      const size = elFilterSize.value;
      const cost = elFilterCost.value;
      document.querySelectorAll('.card').forEach(card => {
        let show = true;
        const text = card.textContent.toLowerCase();
        if (pos && !text.includes(pos.toLowerCase())) show = false;
        if (size && !text.includes(size.toLowerCase())) show = false;
        if (cost && !text.includes(cost.toLowerCase())) show = false;
        card.style.display = show ? '' : 'none';
      });
    }
    [elFilterPos, elFilterSize, elFilterCost].forEach(el => el.addEventListener('change', applyFilters));

    let useChart = false;
    document.getElementById('btnChart').addEventListener('click', () => {
      useChart = !useChart;
      doSearch();
    });

    function render(productName, rows){
      // Show progress
      elProgress.style.display = 'block';
      elProgressBar.style.width = '0%';
      setTimeout(() => { elProgressBar.style.width = '100%'; }, 50);
      setTimeout(() => { elProgress.style.display = 'none'; }, 500);

      elResults.innerHTML = '';
      const header=document.createElement('div'); header.className='card';
      header.style.display='flex'; header.style.alignItems='center'; header.style.justifyContent='space-between'; header.style.flexWrap='wrap'; header.style.gap='12px';
      header.innerHTML = `<div><h3 style="margin:0 0 6px;">${productName}</h3><div class="meta">Positions & maximum embroidery areas (mm)</div></div>`;
      
      // Action buttons container
      const actionBtns = document.createElement('div');
      actionBtns.style.display='flex'; actionBtns.style.gap='8px'; actionBtns.style.flexWrap='wrap';
      
      // Favorite button
      const favBtn = document.createElement('button');
      favBtn.className = favorites.includes(productName) ? 'btn ok' : 'btn ghost';
      favBtn.innerHTML = favorites.includes(productName) ? '<i class="fas fa-star"></i> ƒê√£ y√™u th√≠ch' : '<i class="far fa-star"></i> Y√™u th√≠ch';
      favBtn.addEventListener('click', () => {
        toggleFavorite(productName);
        favBtn.className = favorites.includes(productName) ? 'btn ok' : 'btn ghost';
        favBtn.innerHTML = favorites.includes(productName) ? '<i class="fas fa-star"></i> ƒê√£ y√™u th√≠ch' : '<i class="far fa-star"></i> Y√™u th√≠ch';
      });
      actionBtns.appendChild(favBtn);
      
      // Share button
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn ghost';
      shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share';
      shareBtn.addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: productName,
            text: `K√≠ch th∆∞·ªõc th√™u cho: ${productName}`,
            url: window.location.href
          }).catch(() => {});
        } else {
          navigator.clipboard.writeText(`${productName} - ${window.location.href}`);
          showToast('ƒê√£ copy link', 'success');
        }
      });
      actionBtns.appendChild(shareBtn);
      
      header.appendChild(actionBtns);
      elResults.appendChild(header);

      // collect unique sizes
      const sizeSet=new Set(); rows.forEach(b=>b.rows.forEach(r=>sizeSet.add(r.size))); const sizes=[...sizeSet];
      renderChips(sizes);
      
      // Update quick stats
      function updateQuickStats(rows) {
        const allSizes = new Set();
        const allPositions = new Set();
        let maxH = 0, maxW = 0;
        
        rows.forEach(block => {
          allPositions.add(block.position);
          block.rows.forEach(row => {
            allSizes.add(row.size);
            maxH = Math.max(maxH, row.maxH);
            maxW = Math.max(maxW, row.maxW);
          });
        });
        
        const statTotalSizes = document.getElementById('statTotalSizes');
        const statTotalPositions = document.getElementById('statTotalPositions');
        const statMaxHeight = document.getElementById('statMaxHeight');
        const statMaxWidth = document.getElementById('statMaxWidth');
        const quickStats = document.getElementById('quickStats');
        
        if (statTotalSizes) statTotalSizes.textContent = allSizes.size;
        if (statTotalPositions) statTotalPositions.textContent = allPositions.size;
        if (statMaxHeight) statMaxHeight.textContent = maxH;
        if (statMaxWidth) statMaxWidth.textContent = maxW;
        if (quickStats) quickStats.style.display = 'block';
      }
      updateQuickStats(rows);

      // NEW: Update filters
      const allPos = [...new Set(rows.map(b => b.position))];
      elFilterPos.innerHTML = '<option value="">All Positions</option>' + allPos.map(p => `<option value="${p}">${p}</option>`).join('');
      const allSizes = sizes;
      elFilterSize.innerHTML = '<option value="">All Sizes</option>' + allSizes.map(s => `<option value="${s}">${s}</option>`).join('');
      const allCosts = [...new Set(rows.map(b => b.cost))];
      elFilterCost.innerHTML = '<option value="">All Costs</option>' + allCosts.map(c => `<option value="${c}">${c}</option>`).join('');

      const useMatrix=document.getElementById('toggleMatrix').checked;
      const dense=document.getElementById('toggleDense').checked;

      // NEW: Visual Size Chart
      if (useChart) {
        const card = document.createElement('div'); card.className = 'card';
        const canvas = document.createElement('canvas'); canvas.id = 'chartCanvas';
        card.appendChild(canvas);
        elResults.appendChild(card);
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sizes,
            datasets: [{
              label: 'Max Height (mm)',
              data: sizes.map(s => {
                const avg = rows.flatMap(b => b.rows.filter(r => r.size === s)).reduce((sum, r) => sum + r.maxH, 0) / Math.max(1, rows.flatMap(b => b.rows.filter(r => r.size === s)).length);
                return avg || 0;
              }),
              backgroundColor: 'rgba(101, 183, 255, 0.6)'
            }, {
              label: 'Max Width (mm)',
              data: sizes.map(s => {
                const avg = rows.flatMap(b => b.rows.filter(r => r.size === s)).reduce((sum, r) => sum + r.maxW, 0) / Math.max(1, rows.flatMap(b => b.rows.filter(r => r.size === s)).length);
                return avg || 0;
              }),
              backgroundColor: 'rgba(46, 204, 113, 0.6)'
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
        return;
      }

      if(useMatrix){
        const card=document.createElement('div'); card.className='card';
        const wrap=document.createElement('div'); wrap.className='table-wrap';
        const tbl=document.createElement('table'); tbl.className='sticky'; if(dense) tbl.classList.add('dense');
        const thead=document.createElement('thead'); const hr=document.createElement('tr');
        hr.innerHTML = `<th>Position</th><th>Cost</th>` + sizes.map(s=>`<th>${s}</th>`).join(''); thead.appendChild(hr); tbl.appendChild(thead);
        const tb=document.createElement('tbody');
        rows.forEach(block=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${block.position}</td><td>${block.cost}</td>` + sizes.map(s=>{
            const m=block.rows.find(r=>r.size===s); return `<td>${m? `${m.maxH}√ó${m.maxW}`:'‚Äì'}</td>`;
          }).join('');
          tb.appendChild(tr);
        });
        tbl.appendChild(tb); wrap.appendChild(tbl); card.appendChild(wrap); elResults.appendChild(card);

        // NEW: Sortable & searchable
        const theadTr = tbl.querySelector('thead tr');
        Array.from(theadTr.children).forEach((th, idx) => {
          th.style.cursor = 'pointer';
          th.style.userSelect = 'none';
          th.title = 'Click ƒë·ªÉ s·∫Øp x·∫øp';
          th.addEventListener('click', () => sortTable(idx, tb));
          if (idx > 0) {
            th.innerHTML = `<span style="display:flex; align-items:center; gap:6px;"><i class="fas fa-sort" style="opacity:0.5; font-size:0.8rem;"></i> ${th.textContent}</span>`;
          }
        });
        
        // Add search row above table
        const searchRow = document.createElement('tr');
        searchRow.style.background='transparent';
        const searchCell = document.createElement('td');
        searchCell.colSpan = theadTr.children.length;
        searchCell.style.padding='8px';
        const searchInput = document.createElement('input');
        searchInput.className = 'table-search';
        searchInput.placeholder = 'üîç T√¨m ki·∫øm trong b·∫£ng...';
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          let visibleCount = 0;
          Array.from(tb.children).forEach(tr => {
            const match = Array.from(tr.children).some(td => td.textContent.toLowerCase().includes(term));
            tr.style.display = match ? '' : 'none';
            if (match) visibleCount++;
          });
          if (term) {
            searchInput.style.borderColor = visibleCount > 0 ? 'var(--accent-secondary)' : 'var(--danger)';
          } else {
            searchInput.style.borderColor = 'rgba(101,183,255,0.2)';
          }
        });
        searchCell.appendChild(searchInput);
        searchRow.appendChild(searchCell);
        thead.appendChild(searchRow);
        return;
      }

      // Non-matrix: each position -> table of rows
      rows.forEach(block=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `<div class="meta">${block.position} <span class="pill">Cost: ${block.cost}</span></div>`;
        const wrap=document.createElement('div'); wrap.className='table-wrap';
        const tbl=document.createElement('table'); tbl.className='sticky'; if(dense) tbl.classList.add('dense');
        tbl.innerHTML = `<thead><tr><th>Size</th><th>Max Height (mm)</th><th>Max Width (mm)</th></tr></thead>`;
        const tb=document.createElement('tbody');
        block.rows.forEach(r=>{ const tr=document.createElement('tr'); tr.dataset.size=r.size; tr.innerHTML = `<td>${r.size}</td><td>${r.maxH}</td><td>${r.maxW}</td>`; tb.appendChild(tr); });
        tbl.appendChild(tb); wrap.appendChild(tbl); card.appendChild(wrap); elResults.appendChild(card);
      });

      addToHistory(productName);
      renderHistory();
      renderFavorites();
      applyFilters();
    }

    let sortState = { col: -1, dir: 'asc' };
    function sortTable(colIdx, tbody) {
      const rows = Array.from(tbody.children);
      const isNumeric = colIdx >= 2;
      
      // Toggle sort direction
      if (sortState.col === colIdx) {
        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.col = colIdx;
        sortState.dir = 'asc';
      }
      
      rows.sort((a, b) => {
        let aVal = a.children[colIdx].textContent.trim();
        let bVal = b.children[colIdx].textContent.trim();
        
        if (isNumeric) {
          aVal = parseFloat(aVal.replace(/[^\d.]/g, '')) || 0;
          bVal = parseFloat(bVal.replace(/[^\d.]/g, '')) || 0;
          return sortState.dir === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        const result = aVal.localeCompare(bVal);
        return sortState.dir === 'asc' ? result : -result;
      });
      
      // Update header indicators
      tbody.closest('table').querySelectorAll('th').forEach((th, idx) => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (idx === colIdx) {
          th.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
      
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
      showToast(`ƒê√£ s·∫Øp x·∫øp theo c·ªôt ${colIdx + 1}`, 'success');
    }

    function doSearch(){
      const q=elQ.value.trim();
      if(!q){ elResults.innerHTML='<div class="meta">Type or paste a product name.</div>'; elChips.innerHTML=''; return; }
      const exact=Object.keys(DATA).find(k=>norm(k)===norm(q));
      const cands = exact? [exact] : fuzzyFind(q);
      const chosen = exact || cands[0];
      if(!chosen){ elResults.innerHTML='<div class="meta danger">No match found.</div>'; elChips.innerHTML=''; return; }
      render(chosen, DATA[chosen]);
    }

    // ===== Admin: parse/save =====
    function parseEditor(text){
      // Lines: Position | Cost | Size | H | W
      const lines=(text||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const buckets=new Map(); // key: position||cost -> {position,cost, rows:[]}
      for(const line of lines){
        const parts=line.split('|').map(x=>x.trim());
        if(parts.length<5) continue;
        const [pos, costStr, size, hStr, wStr]=parts;
        const cost = (isNaN(Number(costStr))? costStr : (Number(costStr)||costStr));
        const maxH = Number(hStr); const maxW = Number(wStr);
        if(!pos || !size || !maxH || !maxW) continue;
        const key=`${pos}__${cost}`;
        if(!buckets.has(key)) buckets.set(key, {position:pos, cost:cost, rows:[]});
        buckets.get(key).rows.push({size, maxH, maxW});
      }
      return [...buckets.values()];
    }

    function loadToEditor(name){
      const blocks = DATA[name]; if(!blocks){ elAdminEditor.value=''; return; }
      const lines=[];
      blocks.forEach(b=> b.rows.forEach(r=> lines.push(`${b.position} | ${b.cost} | ${r.size} | ${r.maxH} | ${r.maxW}`)) );
      elAdminEditor.value = lines.join('\n');
    }

    document.getElementById('btnLoad').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const sel=elAdminExisting.value; elAdminName.value=sel; loadToEditor(sel);
    });

    document.getElementById('btnSave').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const name=(elAdminName.value||'').trim(); if(!name) return alert('Product name required');
      const blocks=parseEditor(elAdminEditor.value);
      if(!blocks.length) return alert('Nothing to save. Fill some lines.');
      // NEW: Validate dups
      let hasDup = false;
      blocks.forEach(b => {
        const sizes = b.rows.map(r => r.size);
        if (new Set(sizes).size < sizes.length) hasDup = true;
      });
      if (hasDup) return alert('Duplicate sizes detected!');
      DATA[name]=blocks; saveData(DATA); refreshAuthUI(); alert('Saved.'); doSearch();
    });

    document.getElementById('btnDelete').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const name=(elAdminName.value||'').trim() || elAdminExisting.value;
      if(!name || !DATA[name]) return alert('Choose a valid product');
      if(confirm(`Delete product "${name}"?`)) { delete DATA[name]; saveData(DATA); refreshAuthUI(); elAdminEditor.value=''; elAdminName.value=''; alert('Deleted.'); doSearch(); }
    });

    // NEW: Bulk Import
    document.getElementById('importFile').addEventListener('change', (e) => {
      if (!isLogged()) return alert('Login required');
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: (results) => {
          results.data.forEach(row => {
            if (row.product && row.position && row.cost && row.size && row.maxH && row.maxW) {
              const key = `${row.position}__${row.cost}`;
              if (!DATA[row.product]) DATA[row.product] = [];
              // Find or create block
              let block = DATA[row.product].find(b => b.position === row.position && b.cost === row.cost);
              if (!block) {
                block = {position: row.position, cost: row.cost, rows: []};
                DATA[row.product].push(block);
              }
              block.rows.push({size: row.size, maxH: Number(row.maxH), maxW: Number(row.maxW)});
            }
          });
          saveData(DATA);
          alert('Imported successfully!');
          refreshAuthUI();
        }
      });
    });

    // NEW: Quick Add with Auto-Suggest
    const elQuickSize = document.getElementById('quickSizeSelect');
    const elQuickPos = document.getElementById('quickPos');
    const elQuickCost = document.getElementById('quickCost');
    const elSuggestPreview = document.getElementById('suggestPreview');
    [elQuickSize, elQuickPos].forEach(el => el.addEventListener('change', () => {
      const size = elQuickSize.value;
      const pos = elQuickPos.value;
      if (size && pos) {
        const suggest = SUGGEST_MAP[`${pos}_${size}`];
        if (suggest) {
          elSuggestPreview.textContent = `Suggested: ${suggest.h} x ${suggest.w} mm`;
          elSuggestPreview.style.display = 'block';
        } else {
          elSuggestPreview.style.display = 'none';
        }
      }
    }));
    document.getElementById('btnAddRow').addEventListener('click', () => {
      const size = elQuickSize.value;
      const pos = elQuickPos.value || 'Middle';
      const cost = elQuickCost.value || '4';
      if (!size) return alert('Select a size');
      const suggest = SUGGEST_MAP[`${pos}_${size}`];
      const h = suggest ? suggest.h : 195;
      const w = suggest ? suggest.w : 275;
      const line = `${pos} | ${cost} | ${size} | ${h} | ${w}`;
      elAdminEditor.value += '\n' + line;
      elSuggestPreview.style.display = 'none';
    });

    // NEW: Admin Extra Features
    document.getElementById('btnExportAll').addEventListener('click', () => {
      if (!isLogged()) return alert('Login required');
      const dataStr = JSON.stringify(DATA, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'all_embroidery_data.json';
      link.click();
    });

    document.getElementById('btnClearHistory').addEventListener('click', () => {
      if (!isLogged()) return alert('Login required');
      if (confirm('Clear all user search history?')) {
        localStorage.removeItem(LS_HISTORY);
        history = [];
        renderHistory();
        alert('History cleared.');
      }
    });

    document.getElementById('btnClearFavorites').addEventListener('click', () => {
      if (!isLogged()) return alert('Login required');
      if (confirm('Clear all favorites?')) {
        localStorage.removeItem(LS_FAVS);
        favorites = [];
        renderFavorites();
        alert('Favorites cleared.');
      }
    });

    document.getElementById('btnResetData').addEventListener('click', () => {
      if (!isLogged()) return alert('Login required');
      if (confirm('Reset all data to seed data? This cannot be undone.')) {
        localStorage.removeItem(LS_KEY);
        DATA = loadData();
        saveData(DATA);
        refreshAuthUI();
        alert('Data reset to seed.');
        doSearch();
      }
    });

    // ===== Enhanced Export =====
    document.getElementById('btnExport').addEventListener('click', () => {
      const product = elQ.value.trim();
      if (!product || !DATA[product]) return showToast('T√¨m s·∫£n ph·∫©m tr∆∞·ªõc', 'error');
      const rows = DATA[product];
      
      // Create export menu
      const menu = document.createElement('div');
      menu.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:20px; z-index:10000; box-shadow:0 20px 60px rgba(0,0,0,0.5); min-width:300px;';
      menu.innerHTML = `
        <h3 style="margin:0 0 15px;">üì• Xu·∫•t d·ªØ li·ªáu</h3>
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportAs('csv')"><i class="fas fa-file-csv"></i> CSV</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportAs('json')"><i class="fas fa-file-code"></i> JSON</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportAs('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
        <button class="btn ghost" style="width:100%;" onclick="this.closest('div').remove()">H·ªßy</button>
      `;
      
      window.exportAs = (format) => {
        if (format === 'csv') {
          const csvContent = 'Position,Cost,Size,MaxH,MaxW\n' + rows.flatMap(b => b.rows.map(r => `${b.position},${b.cost},${r.size},${r.maxH},${r.maxW}`)).join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${product.replace(/[^a-z0-9]/gi, '_')}.csv`;
          link.click();
          URL.revokeObjectURL(link.href);
          showToast('ƒê√£ xu·∫•t CSV', 'success');
        } else if (format === 'json') {
          const jsonContent = JSON.stringify({ product, data: rows }, null, 2);
          const blob = new Blob([jsonContent], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${product.replace(/[^a-z0-9]/gi, '_')}.json`;
          link.click();
          URL.revokeObjectURL(link.href);
          showToast('ƒê√£ xu·∫•t JSON', 'success');
        } else if (format === 'pdf') {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text(`${product} - K√≠ch th∆∞·ªõc th√™u`, 14, 20);
          doc.setFontSize(10);
          const tableData = rows.flatMap(b => b.rows.map(r => [b.position, b.cost, r.size, `${r.maxH}√ó${r.maxW}mm`]));
          doc.autoTable({ 
            head: [['V·ªã tr√≠', 'Chi ph√≠', 'K√≠ch c·ª°', 'K√≠ch th∆∞·ªõc']], 
            body: tableData,
            styles: { fontSize: 9 },
            headStyles: { fillColor: [101, 183, 255] }
          });
          doc.save(`${product.replace(/[^a-z0-9]/gi, '_')}.pdf`);
          showToast('ƒê√£ xu·∫•t PDF', 'success');
        }
        menu.remove();
      };
      
      document.body.appendChild(menu);
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;';
      overlay.onclick = () => { menu.remove(); overlay.remove(); };
      document.body.appendChild(overlay);
    });
    
    // Bookmark button
    document.getElementById('btnBookmark')?.addEventListener('click', () => {
      const product = elQ.value.trim();
      if (!product || !DATA[product]) return showToast('T√¨m s·∫£n ph·∫©m tr∆∞·ªõc', 'error');
      toggleFavorite(product);
      const btn = document.getElementById('btnBookmark');
      btn.className = favorites.includes(product) ? 'btn ok' : 'btn ghost';
      btn.innerHTML = favorites.includes(product) ? '<i class="fas fa-bookmark"></i> ƒê√£ bookmark' : '<i class="far fa-bookmark"></i> Bookmark';
    });
    
    // Share button handler
    document.getElementById('btnShare')?.addEventListener('click', () => {
      const product = elQ.value.trim();
      if (!product || !DATA[product]) return showToast('T√¨m s·∫£n ph·∫©m tr∆∞·ªõc', 'error');
      
      if (navigator.share) {
        navigator.share({
          title: `${product} - K√≠ch th∆∞·ªõc th√™u`,
          text: `Th√¥ng tin k√≠ch th∆∞·ªõc th√™u cho: ${product}`,
          url: window.location.href
        }).catch(() => {});
      } else {
        const text = `${product}\n${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => {
          showToast('ƒê√£ copy link v√†o clipboard', 'success');
        });
      }
    });

    // ===== Wire up search & clipboard =====
    document.getElementById('btnPaste').addEventListener('click', async()=>{
      try{ const t=await navigator.clipboard.readText(); if(t){ elQ.value=t.trim(); doSearch(); } }
      catch(e){ alert('Clipboard permission denied. Use Ctrl/‚åò+V.'); }
    });
    document.getElementById('btnClear').addEventListener('click',()=>{ elQ.value=''; elResults.innerHTML=''; elChips.innerHTML=''; elQ.focus(); });
    document.getElementById('btnPrint').addEventListener('click',()=>{
      window.print();
      showToast('ƒêang in...', 'info');
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'v' && document.activeElement === elQ) {
        setTimeout(doSearch, 100);
      }
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        window.print();
      }
    });
    document.getElementById('toggleMatrix').addEventListener('change', doSearch);
    document.getElementById('toggleDense').addEventListener('change', doSearch);

    elQ.addEventListener('input', debounce(doSearch, 250));
    elQ.addEventListener('paste', ()=> setTimeout(doSearch, 0));

    // NEW: PWA Offline Mode
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', e => {
          e.waitUntil(caches.open('embroidery-v1').then(cache => cache.addAll(['index.html', './'])));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
        });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(console.error);
    }
    // Prompt install if PWA
    window.addEventListener('beforeinstallprompt', (e) => {
      e.prompt();
    });

    // ===== NEW: Chat Functionality - User Log (No Bot, Always Visible) =====
    const elChatToggle = document.getElementById('chatToggle');
    const elChatModal = document.getElementById('chatModal');
    const elChatMessages = document.getElementById('chatMessages');
    const elChatInput = document.getElementById('chatInput');
    const elSendBtn = document.getElementById('sendBtn');

    // Load and clean chat history (remove messages older than 1 day)
    let chatHistory = JSON.parse(localStorage.getItem(LS_CHAT) || '[]');
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
    chatHistory = chatHistory.filter(msg => new Date(msg.timestamp) > new Date(oneDayAgo));
    localStorage.setItem(LS_CHAT, JSON.stringify(chatHistory));

    function renderChat() {
      elChatMessages.innerHTML = chatHistory.map(msg => 
        `<div class="message ${msg.type}">
          <div class="sender">${msg.sender}</div>
          <div>${msg.text}</div>
          <div class="time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
        </div>`
      ).join('');
      elChatMessages.scrollTop = elChatMessages.scrollHeight;
    }

    function addMessage(text, type, sender) {
      chatHistory.push({ text, type, sender, timestamp: new Date().toISOString() });
      localStorage.setItem(LS_CHAT, JSON.stringify(chatHistory));
      renderChat();
    }

    function sendMessage() {
      const msg = elChatInput.value.trim();
      if (!msg) return;
      const isAdmin = isLogged();
      const sender = isAdmin ? 'Admin' : getUserAnimalName();
      const type = isAdmin ? 'admin' : 'user';
      addMessage(msg, type, sender);
      elChatInput.value = '';
    }

    elSendBtn.addEventListener('click', sendMessage);
    elChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Toggle chat visibility
    elChatToggle.addEventListener('click', () => {
      elChatModal.classList.toggle('hidden');
      elChatToggle.innerHTML = elChatModal.classList.contains('hidden') ? '<i class="fas fa-comments"></i>' : '<i class="fas fa-comments-slash"></i>';
    });

    // Always render chat on load
    renderChat();

    // Init
    refreshAuthUI();
    renderFavorites();
    renderHistory();
    elQ.value='Embroidered Shorts for Women';
    doSearch();
    
    // Optimized loading - delay animations
    requestAnimationFrame(() => {
      document.body.classList.add('loaded');
      document.querySelector('header')?.classList.add('loaded');
      document.querySelector('.panel')?.classList.add('loaded');
    });
  </script>
</body>
</html>