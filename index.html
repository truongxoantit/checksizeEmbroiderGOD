<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Embroidery Size Checker – Full Upgraded Features</title>
  <!-- NEW: Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- NEW: jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- NEW: Chart.js for Visual Size Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- NEW: PapaParse for Bulk Import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- NEW: PWA Manifest (inline for single file) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRW1icm9pZGVyeSBDaGVja2VyIiwiY29sb3IiOiIjNjViN2ZmIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK2Jhc2U2NCxzdmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121923; --muted:#8ca0b6; --text:#e6edf3; --accent:#65b7ff; --chip:#1b2430;
      --ok:#2ecc71; --danger:#ff6b6b; --warn:#f39c12;
      --radius:16px; --radius-sm:10px;
    }
    /* NEW: Light mode vars */
    :root.light {
      --bg:#f8f9fa; --panel:#ffffff; --muted:#6c757d; --text:#212529; --accent:#0d6efd; --chip:#e9ecef;
      --ok:#198754; --danger:#dc3545; --warn:#fd7e14;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,var(--bg) 0%, #0e1420 100%); color:var(--text); transition: background 0.3s, color 0.3s;}
    header{position:sticky; top:0; background:rgba(10,14,20,.7); backdrop-filter:blur(8px); border-bottom:1px solid #1f2a36; z-index:10}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px}
    h1{margin:0 0 6px; font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:.95rem}
    .panel{background:var(--panel); border:1px solid #1f2a36; border-radius:var(--radius); padding:14px; transition: background 0.3s;}

    .searchbar{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; position:relative}
    /* NEW: Autocomplete dropdown */
    #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel); border: 1px solid var(--accent); border-radius: var(--radius-sm); max-height: 200px; overflow-y: auto; z-index: 20; display: none; }
    #suggestions div { padding: 10px; cursor: pointer; transition: background 0.2s; }
    #suggestions div:hover { background: rgba(101, 183, 255, 0.1); }
    input[type="text"], input[type="password"]{width:100%; font-size:1.05rem; padding:12px 14px; background:#0f1622; color:var(--text); border:1px solid #233041; border-radius:var(--radius-sm); outline:0; transition: border-color 0.2s;}
    input[type="text"]:focus, input[type="password"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(100,180,255,.12)}
    /* NEW: Light mode input */
    :root.light input[type="text"], :root.light input[type="password"] { background: #fff; border-color: #ced4da; }
    .btn{padding:10px 12px; background:#172538; color:#eaf6ff; border:1px solid #2b415c; border-radius:var(--radius-sm); cursor:pointer; font-weight:700; transition: transform 0.2s, background 0.2s;}
    .btn:hover { transform: scale(1.02); }
    .btn.ghost{background:#0f1622}
    .btn.warn{background:#2a1f12; border-color:#6b4b14}
    .btn.ok{background:#142a1f; border-color:#1b5f3a}
    /* NEW: Light mode btn */
    :root.light .btn { background: #e9ecef; color: #212529; border-color: #adb5bd; }
    :root.light .btn.ghost { background: #f8f9fa; }

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; animation: fadeIn 0.3s ease-in;}
    .chip{padding:7px 10px; border:1px solid #293648; background:var(--chip); color:#cfe4ff; border-radius:999px; font-size:.84rem; cursor:pointer; transition: transform 0.2s;}
    .chip:hover { transform: scale(1.05); }
    .chip.active{background:#1a2f44; border-color:#3e76a8}

    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .controls .group{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #28405a;background:#0f1c2d;border-radius:10px}
    .controls select, .controls input[type="checkbox"]{background:#0f1622;color:#e6f2ff;border:1px solid #28405a;border-radius:8px;padding:6px 8px}
    /* NEW: Light mode controls */
    :root.light .controls .group { background: #f8f9fa; border-color: #dee2e6; }
    :root.light .controls select, :root.light .controls input[type="checkbox"] { background: #fff; color: #212529; border-color: #ced4da; }

    /* NEW: History & Favorites section */
    .history { margin-top: 10px; padding: 10px; background: var(--chip); border-radius: var(--radius-sm); }
    .history .chips { justify-content: flex-start; }
    #favorites { margin-top: 10px; }

    .results{margin-top:14px; display:grid; gap:14px; animation: fadeIn 0.3s ease-in;}
    .card{background:#0f1622; border:1px solid #223246; border-radius:var(--radius); padding:14px; transition: transform 0.2s;}
    .card:hover { transform: scale(1.01); }
    .card h3{margin:0 0 6px}
    .meta{color:var(--muted); font-size:.9rem}
    /* NEW: Light mode card */
    :root.light .card { background: #fff; border-color: #dee2e6; }

    .table-wrap{max-height:60vh;overflow:auto;border-radius:12px}
    table{width:max-content; min-width:100%; border-collapse:collapse; border:1px solid #223246}
    thead{background:#132033}
    th, td{padding:8px 10px; text-align:left; border-bottom:1px dashed #1e2d42; white-space:nowrap; cursor: pointer; transition: background 0.2s;}
    th:hover { background: rgba(101, 183, 255, 0.1); }
    .sticky thead th{position:sticky; top:0; z-index:2}
    .dense th,.dense td{padding:4px 6px; font-size:.9rem}
    .pill{display:inline-block; padding:4px 8px; border:1px solid #28405a; border-radius:999px; background:#112036; font-size:.78rem}
    /* NEW: Searchable table input */
    .table-search { width: 100%; padding: 5px; background: var(--panel); border: none; margin-bottom: 5px; }
    tr:hover { background: rgba(101, 183, 255, 0.05); }

    /* NEW: Chart canvas */
    #chartCanvas { max-height: 400px; width: 100%; }

    .footer{margin:24px 0 40px; color:#86a1bd; font-size:.85rem}
    .kbd{border:1px solid #3a4f6a; background:#0c1421; padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}

    /* NEW: Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* NEW: Theme toggle */
    #themeToggle { cursor: pointer; font-size: 1.2rem; padding: 5px; border-radius: 50%; transition: background 0.2s; }
    #themeToggle:hover { background: rgba(255,255,255,0.1); }

    /* NEW: Progress bar */
    #progress { width: 100%; height: 3px; background: var(--muted); margin-top: 10px; overflow: hidden; display: none; }
    #progressBar { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }

    /* NEW: Responsive */
    @media (max-width: 768px) {
      .wrap { padding: 10px; }
      .controls { flex-direction: column; }
      .table-wrap { font-size: 0.8rem; }
      .chips { justify-content: flex-start; overflow-x: auto; }
    }

    /* Admin bar */
    .adminbar{margin-top:14px; display:none}
    .adminbar.active{display:block}
    .admin-grid{display:grid; grid-template-columns:1fr; gap:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    textarea{width:100%; min-height:160px; background:#0f1622; color:#e6edf3; border:1px solid #233041; border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    select{background:#0f1622; color:#e6edf3; border:1px solid #233041; border-radius:10px; padding:8px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#163524; color:#a8f0c1; border:1px solid #2a6b46; font-size:.8rem}
    .danger{color:#ff9e9e}
    /* NEW: Admin quick add & bulk import */
    #quickSizes { margin-bottom: 10px; }
    #btnAddRow { background: var(--ok); }
    #importFile { display: none; }
    .file-upload { cursor: pointer; padding: 10px; background: var(--ok); color: white; border-radius: var(--radius-sm); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><i class="fas fa-threaded"></i> Embroidery Size Checker</h1>
      <div class="sub">Type or paste a product name (English). Auto-search enabled. Example: <span class="kbd">Embroidered Shorts for Women</span> <span id="modeBadge"></span>
      <!-- NEW: Theme toggle -->
      <i id="themeToggle" class="fas fa-moon" title="Toggle Dark/Light Mode"></i>
      <!-- NEW: Language select -->
      <select id="langSelect" title="Language">
        <option value="en">EN</option>
        <option value="vi">VI</option>
      </select>
      </div>
    </div>
  </header>
  <main class="wrap">
    <section class="panel">
      <div class="searchbar">
        <input id="q" type="text" placeholder="Type or paste product name..." autocomplete="off" />
        <!-- NEW: Autocomplete dropdown -->
        <div id="suggestions"></div>
        <div class="actions">
          <button class="btn ghost" id="btnPaste" title="Paste from clipboard"><i class="fas fa-clipboard"></i> Paste</button>
          <button class="btn ghost" id="btnClear" title="Clear input"><i class="fas fa-trash"></i> Clear</button>
          <button class="btn ghost" id="btnPrint" title="Print results"><i class="fas fa-print"></i> Print</button>
          <!-- NEW: Export button -->
          <button class="btn ghost" id="btnExport" title="Export to CSV/PDF"><i class="fas fa-download"></i> Export</button>
          <!-- NEW: Chart toggle -->
          <button class="btn ghost" id="btnChart" title="Toggle Chart View"><i class="fas fa-chart-bar"></i> Chart</button>
        </div>
      </div>
      <!-- NEW: Progress bar -->
      <div id="progress"><div id="progressBar"></div></div>

      <!-- NEW: History section -->
      <div class="history" id="history" style="display:none"></div>

      <div class="chips" id="chips"></div>

      <div class="controls">
        <div class="group">
          <label><input type="checkbox" id="toggleMatrix" checked> <i class="fas fa-table"></i> Matrix view</label>
          <label><input type="checkbox" id="toggleDense"> <i class="fas fa-compress"></i> Dense</label>
          <!-- NEW: Regex mode -->
          <label><input type="checkbox" id="toggleRegex"> Regex mode</label>
        </div>
        <!-- NEW: Advanced filters -->
        <div class="group">
          <select id="filterPos"><option value="">All Positions</option></select>
          <select id="filterSize"><option value="">All Sizes</option></select>
          <select id="filterCost"><option value="">All Costs</option></select>
        </div>
        <div class="group">
          <button class="btn" id="btnLogin" title="Admin login"><i class="fas fa-lock"></i> Admin login</button>
          <button class="btn ghost" id="btnLogout" style="display:none" title="Logout"><i class="fas fa-unlock"></i> Logout</button>
        </div>
      </div>

      <!-- NEW: Favorites section -->
      <div id="favorites" style="display:none">
        <h4><i class="fas fa-star"></i> Favorites</h4>
        <div class="chips" id="favChips"></div>
      </div>

      <!-- Admin Console -->
      <div class="adminbar" id="adminBar">
        <div class="card">
          <h3>Admin Console <span class="badge">edit mode</span></h3>
          <div class="admin-grid">
            <div class="row">
              <label>Product: <input id="adminProductName" type="text" placeholder="Exact product name" /></label>
              <select id="adminExisting"></select>
              <button class="btn" id="btnLoad"><i class="fas fa-upload"></i> Load</button>
              <button class="btn ok" id="btnSave"><i class="fas fa-save"></i> Save</button>
              <button class="btn warn" id="btnDelete"><i class="fas fa-trash"></i> Delete</button>
              <!-- NEW: Bulk Import -->
              <label class="file-upload" for="importFile"><i class="fas fa-upload"></i> Import CSV</label>
              <input type="file" id="importFile" accept=".csv" />
            </div>
            <!-- NEW: Quick Add Size with Auto-Suggest -->
            <div id="quickSizes" class="row">
              <select id="quickSizeSelect">
                <option value="">Select Size to Add</option>
                <option value="XS">XS</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
                <option value="2XL">2XL</option>
                <option value="3XL">3XL</option>
                <option value="4XL">4XL</option>
                <option value="5XL">5XL</option>
                <option value="0-3M">0-3M (Baby)</option>
                <option value="Newborn">Newborn</option>
              </select>
              <input id="quickPos" type="text" placeholder="Position (e.g. Middle)" />
              <input id="quickCost" type="text" placeholder="Cost (e.g. 4)" />
              <button class="btn ok" id="btnAddRow">Add Row</button>
              <div id="suggestPreview" class="sub" style="display:none"></div>
            </div>
            <div>
              <textarea id="adminEditor" placeholder="Enter lines: Position | Cost | Size | MaxHeight | MaxWidth
Example:
Middle | 4 | XS | 195 | 275
..."></textarea>
            </div>
            <div class="sub">Hint: Each line = one size row. Same Position+Cost can repeat for multiple sizes. Numbers are in mm. Use Quick Add for new sizes.</div>
          </div>
        </div>
      </div>

      <div class="results" id="results"></div>
      <div class="sub" style="margin-top:8px">Tips: <span class="kbd">Ctrl/⌘+V</span> to paste. Use chips to filter a single size in non-matrix view.</div>
    </section>

    <p class="footer">All measurements in millimetres (mm). Unauthenticated users can only search; editing requires admin login. Upgraded: Charts, Bulk Import, Auto-Suggest, Multi-Lang, PWA.</p>
  </main>

  <script>
    // ===== Utilities =====
    const mm = (x)=>x;
    const norm = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
    const titleCase = (s)=> (s||'').replace(/\s+/g,' ').trim().replace(/(^|\s)[a-z]/g, m=>m.toUpperCase());
    const debounce=(fn,ms)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms)}};

    function expandSizes(raw){
      if (Array.isArray(raw)) return raw;
      if (!raw || typeof raw !== 'string') return [String(raw||'All')];
      const cleaned = raw.replaceAll('\u00a0',' ').replace(/\s+/g,' ');
      return cleaned.replaceAll(' - ','-').replaceAll(' – ','-').replaceAll(',', '-')
        .split(/-|\/|\u2013/).map(s=>s.trim()).filter(Boolean);
    }
    const makeRows = (sizes,h,w)=>expandSizes(sizes).map(sz=>({size:sz||'All', maxH:mm(h), maxW:mm(w)}));

    // ===== Seed Data (built-in) - FULL FROM ORIGINAL =====
    const group_COMMON_TOPS = [
      {position:'Middle', cost:4, rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Chest', cost:3, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],140,140),...makeRows(['L'],150,150),...makeRows(['XL'],150,150),...makeRows(['2XL'],150,150),...makeRows(['3XL'],160,160),...makeRows(['4XL'],170,170),...makeRows(['5XL'],175,175)]},
      {position:'Neck', cost:1, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],135,135),...makeRows(['L'],135,135),...makeRows(['XL'],145,145),...makeRows(['2XL'],145,145),...makeRows(['3XL'],155,155),...makeRows(['4XL'],165,165),...makeRows(['5XL'],170,170)]},
      {position:'Arm', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Arm', cost:6, rows:[...makeRows(['All'],138,78)]},
      {position:'Cuff', cost:8, rows:[...makeRows(['All'],38,78)]},
      {position:'Cuff', cost:9, rows:[...makeRows(['All'],38,78)]},
      {position:'Back', cost:'B', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Pocket', cost:'P', rows:[...makeRows(['All'],38,78)]},
    ];
    const group_LONG_SLEEVE_TEE = [
      {position:'Front', cost:'F', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Chest', cost:3, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],140,140),...makeRows(['L'],150,150),...makeRows(['XL'],150,150),...makeRows(['2XL'],150,150),...makeRows(['3XL'],160,160),...makeRows(['4XL'],170,170),...makeRows(['5XL'],175,175)]},
      {position:'Neck', cost:1, rows:[...makeRows(['XS'],120,120),...makeRows(['S'],130,130),...makeRows(['M'],135,135),...makeRows(['L'],135,135),...makeRows(['XL'],145,145),...makeRows(['2XL'],145,145),...makeRows(['3XL'],155,155),...makeRows(['4XL'],165,165),...makeRows(['5XL'],170,170)]},
      {position:'Sleeve', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Sleeve', cost:6, rows:[...makeRows(['All'],138,78)]},
    ];
    const group_SLIT_SIDE = [
      {position:'Front', cost:'F', rows:[...makeRows(['XS'],195,275),...makeRows(['S'],195,285),...makeRows(['M'],195,295),...makeRows(['L'],195,295),...makeRows(['XL'],250,320),...makeRows(['2XL'],250,330),...makeRows(['3XL'],250,340),...makeRows(['4XL'],250,360),...makeRows(['5XL'],250,370)]},
      {position:'Slit Side', cost:'E', rows:[...makeRows(['All'],165,165)]},
      {position:'Slit Side', cost:'S', rows:[...makeRows(['All'],165,165)]},
      {position:'Sleeve', cost:5, rows:[...makeRows(['All'],138,78)]},
      {position:'Sleeve', cost:6, rows:[...makeRows(['All'],138,78)]},
    ];

    const SEED = {
      "Embroidered Hoodie": group_COMMON_TOPS,
      "Embroidered T-Shirt": group_COMMON_TOPS,
      "Embroidered Sweatshirt": group_COMMON_TOPS,
      "Polo Shirt": group_COMMON_TOPS,
      "Embroidered T-Shirt Pocket": group_COMMON_TOPS,
      "Women Sweater": group_COMMON_TOPS,
      "Adult Knit Sweater": group_COMMON_TOPS,
      "Floral Embroidery": group_COMMON_TOPS,
      "Applique Bow": group_COMMON_TOPS,
      "Felt Embroidered Sweatshirt": group_COMMON_TOPS,
      "Felt Embroidered Hoodie": group_COMMON_TOPS,
      "Felt Embroidered T-shirt": group_COMMON_TOPS,
      "Embroidered Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Hoodie V-Notch": group_COMMON_TOPS,
      "Embroidered T-shirt V-Notch": group_COMMON_TOPS,
      "Embroidered Applique Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Quarter Zip Pullover Sweatshirt": group_COMMON_TOPS,
      "Embroidered Applique Quater Zip Pullover Sweatshirt": group_COMMON_TOPS,
      "Embroidered Faux Fur Sweatshirt V-Notch": group_COMMON_TOPS,
      "Embroidered Sweatshirt MIX": group_COMMON_TOPS,
      "Embroidered Faux Fur T-shirt V-Notch": group_COMMON_TOPS,

      "Embroidered Long-Sleeve T-Shirt": group_LONG_SLEEVE_TEE,

      "Slit Side Glitter Embroidery": group_SLIT_SIDE,
      "Glitter": group_SLIT_SIDE,
      "Hem Cut & Slit Side Glitter Embroidery": group_SLIT_SIDE,
      "Slit Side Embroidery": group_SLIT_SIDE,
      "Glitter Bow": group_SLIT_SIDE,
      "Hem Cut & Slit Side Embroidery": group_SLIT_SIDE,

      "Embroidered Shorts for Women": [
        {position:'1 side', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(78), maxW:mm(137)})),
          ...expandSizes('XL - 2XL-3XL').map(sz=>({size:sz, maxH:mm(198), maxW:mm(198)})),
        ]},
      ],

      "Embroidered Sweatpants Add on": [
        {position:'Thigh', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(73), maxW:mm(98)})),
          ...expandSizes('XL - 2XL').map(sz=>({size:sz, maxH:mm(108), maxW:mm(118)})),
          ...expandSizes('3XL-4XL').map(sz=>({size:sz, maxH:mm(118), maxW:mm(137)})),
        ]},
        {position:'Leg', cost:4, rows:[{size:'All', maxH:mm(160), maxW:mm(87)}]},
      ],

      "Cap": [
        {position:'Front side', cost:'F', rows:[{size:'All', maxH:mm(59), maxW:mm(120)}]},
        {position:'Back side', cost:'B', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Left side', cost:'L', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Right side', cost:'R', rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
      ],

      "Embroidery Golf Towel": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(95), maxW:mm(95)}]},
      ],

      "Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Muslin Blanked Embroidered": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Baby Bib Muslin": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Bib Attachment": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Ruffle Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Heirloom Lace Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Ruffle Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Classic Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Heirloom Lace Baby Knit Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],
      "Embroidered Ruffle Edge Blanket": [{position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(295)}]}],

      "Baby Onesie": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3M', maxH:mm(78), maxW:mm(137)},
          {size:'6M', maxH:mm(78), maxW:mm(137)},
          {size:'9M', maxH:mm(78), maxW:mm(137)},
          {size:'12M', maxH:mm(150), maxW:mm(150)},
          {size:'18M', maxH:mm(150), maxW:mm(150)},
          {size:'24M', maxH:mm(170), maxW:mm(170)},
        ]},
      ],

      "Embroidered Kids Knit Sweater": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(145), maxW:mm(165)},
          {size:'3-6 months', maxH:mm(145), maxW:mm(165)},
          {size:'9-12 months', maxH:mm(145), maxW:mm(170)},
          {size:'12-18 months', maxH:mm(145), maxW:mm(195)},
          {size:'18-24m or 2T', maxH:mm(145), maxW:mm(195)},
        ]},
      ],

      "Embroidered Baby Girl Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3M', maxH:mm(70), maxW:mm(80)},
          {size:'3-6M', maxH:mm(75), maxW:mm(85)},
          {size:'6-12-18M', maxH:mm(75), maxW:mm(95)},
        ]},
      ],

      "Embroidered Classic Baby Sweater": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3 months', maxH:mm(190), maxW:mm(180)},
          {size:'3-6 months', maxH:mm(190), maxW:mm(180)},
          {size:'6-9 months', maxH:mm(195), maxW:mm(195)},
          {size:'9-12 months', maxH:mm(195), maxW:mm(195)},
          {size:'12-18 months', maxH:mm(195), maxW:mm(195)},
          {size:'18-24 months', maxH:mm(195), maxW:mm(195)},
        ]},
      ],

      "Ruffle Baby Girl Knit Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'Newborn', maxH:mm(118), maxW:mm(148)},
          {size:'0-3 Months', maxH:mm(128), maxW:mm(162)},
          {size:'3-6 Months', maxH:mm(143), maxW:mm(178)},
        ]},
      ],
      
      "Embroidered Baby Boy Knit Romper": [
        {position:'1 side', cost:4, rows:[
          {size:'Newborn', maxH:mm(118), maxW:mm(148)},
          {size:'0-3 Months', maxH:mm(128), maxW:mm(162)},
          {size:'3-6 Months', maxH:mm(143), maxW:mm(178)},
        ]},
      ],

      "Body Suit Embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'Premie', maxH:mm(88), maxW:mm(98)},
          {size:'Newborn', maxH:mm(88), maxW:mm(108)},
          {size:'0-3 months', maxH:mm(88), maxW:mm(118)},
          {size:'3-6 months', maxH:mm(108), maxW:mm(128)},
          {size:'6-12 months', maxH:mm(118), maxW:mm(138)},
          {size:'12-18 months', maxH:mm(128), maxW:mm(148)},
          {size:'18-24 months', maxH:mm(128), maxW:mm(168)},
        ]},
        {position:'Chest', cost:3, rows:[
          {size:'Premie', maxH:mm(33), maxW:mm(33)},
          {size:'Newborn', maxH:mm(33), maxW:mm(33)},
          {size:'0-3 months', maxH:mm(38), maxW:mm(38)},
          {size:'3-6 months', maxH:mm(43), maxW:mm(43)},
          {size:'6-12 months', maxH:mm(43), maxW:mm(48)},
          {size:'12-18 months', maxH:mm(48), maxW:mm(58)},
          {size:'18-24 months', maxH:mm(58), maxW:mm(68)},
        ]},
      ],

      "Baby Wool Bodysuit": [
        {position:'1 side', cost:4, rows:[
          {size:'0-3M', maxH:mm(160), maxW:mm(160)},
          {size:'3-6M', maxH:mm(160), maxW:mm(160)},
          {size:'6-9M', maxH:mm(160), maxW:mm(160)},
          {size:'9-12M', maxH:mm(180), maxW:mm(180)},
          {size:'12-18M', maxH:mm(180), maxW:mm(180)},
          {size:'18-24M', maxH:mm(180), maxW:mm(180)},
        ]},
      ],

      "Embroidered Premium Burp Cloth": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(165), maxW:mm(165)}]},
      ],

      "Denim Jacket": [
        {position:'Back', cost:'B', rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(165), maxW:mm(265)})),
          ...expandSizes('XL - 2XL').map(sz=>({size:sz, maxH:mm(175), maxW:mm(275)})),
          {size:'3Xl', maxH:mm(185), maxW:mm(285)},
          ...expandSizes('4XL-5XL').map(sz=>({size:sz, maxH:mm(195), maxW:mm(295)})),
        ]},
        {position:'Collar', cost:11, rows:[{size:'All', maxH:mm(33), maxW:mm(195)}]},
        {position:'Shoulder', cost:12, rows:[
          ...expandSizes('S-M-L-XL-2XL').map(sz=>({size:sz, maxH:mm(78), maxW:mm(195)})),
          ...expandSizes('3XL-4XL').map(sz=>({size:sz, maxH:mm(58), maxW:mm(245)})),
        ]},
        {position:'Arm', cost:5, rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
        {position:'Arm', cost:6, rows:[{size:'All', maxH:mm(38), maxW:mm(78)}]},
      ],

      "Embroidered Linen Apron": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(245)}]},
      ],
      "Embroidered Linen Apron With Two Pockets Middle-Pocket": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(195), maxW:mm(245)}]},
        {position:'Pocket', cost:5, rows:[...expandSizes('S - M').map(sz=>({size:sz, maxH:mm(95), maxW:mm(70)})), {size:'L', maxH:mm(125), maxW:mm(70)}]},
        {position:'Pocket', cost:6, rows:[...expandSizes('S - M').map(sz=>({size:sz, maxH:mm(95), maxW:mm(70)})), {size:'L', maxH:mm(125), maxW:mm(70)}]},
      ],

      "Embroidered Sleep Bag": [
        {position:'Middle', cost:4, rows:[
          ...expandSizes('XS - S - M').map(sz=>({size:sz, maxH:mm(70), maxW:mm(130)})),
          ...expandSizes('L - XL').map(sz=>({size:sz, maxH:mm(82), maxW:mm(150)})),
        ]}
      ],

      "Baby Knotted Cap embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(28), maxW:mm(133)},
          {size:'3-6 months', maxH:mm(28), maxW:mm(133)},
          {size:'6-12 months', maxH:mm(28), maxW:mm(133)},
          {size:'12-18 months', maxH:mm(28), maxW:mm(133)},
          {size:'18-24 months', maxH:mm(28), maxW:mm(133)},
        ]},
      ],

      "Baby Bow Embroidered": [
        {position:'Middle', cost:4, rows:[
          {size:'0-3 months', maxH:mm(28), maxW:mm(133)},
          {size:'3-6 months', maxH:mm(28), maxW:mm(133)},
          {size:'6-12 months', maxH:mm(28), maxW:mm(133)},
          {size:'12-18 months', maxH:mm(28), maxW:mm(133)},
          {size:'18-24 months', maxH:mm(28), maxW:mm(133)},
          {size:'1-2 years', maxH:mm(38), maxW:mm(133)},
          {size:'2-3 years', maxH:mm(38), maxW:mm(133)},
          {size:'3-4 years', maxH:mm(38), maxW:mm(133)},
        ]},
      ],

      "Embroidered Canvas Strap Tote Bag": [
        {position:'Middle', cost:4, rows:[
          {size:'S', maxH:mm(38), maxW:mm(115)},
          {size:'M', maxH:mm(68), maxW:mm(155)},
          {size:'L', maxH:mm(175), maxW:mm(105)},
        ]}
      ],

      "Christmas Stocking": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(78), maxW:mm(135)}]},
      ],

      "Embroidered Dog Bandana Attachment": [
        {position:'Middle', cost:4, rows:[{size:'S', maxH:mm(125), maxW:mm(145)}, {size:'L', maxH:mm(140), maxW:mm(170)}]},
      ],
      "Embroidered Dog Bandana": [
        {position:'Middle', cost:4, rows:[{size:'S', maxH:mm(125), maxW:mm(145)}, {size:'L', maxH:mm(140), maxW:mm(170)}]},
        {position:'1 side', cost:4, rows:[
          ...expandSizes('XS - S-M -L').map(sz=>({size:sz, maxH:mm(195), maxW:mm(295)})),
          ...expandSizes('XL - 2XL -3XL').map(sz=>({size:sz, maxH:mm(250), maxW:mm(325)})),
          ...expandSizes('4XL đến 5XL').map(sz=>({size:sz, maxH:mm(250), maxW:mm(350)})),
        ]}
      ],

      "Socks Embroider": [
        {position:'Middle', cost:4, rows:[{size:'All', maxH:mm(38), maxW:mm(48)}]},
      ],
    };

    // NEW: Suggest Map for Auto-Suggest (derived from SEED)
    const SUGGEST_MAP = {};
    Object.values(SEED).forEach(blocks => {
      blocks.forEach(block => {
        block.rows.forEach(row => {
          const key = `${block.position}_${row.size}`;
          if (!SUGGEST_MAP[key]) SUGGEST_MAP[key] = {h: row.maxH, w: row.maxW};
        });
      });
    });

    // NEW: Language Map (simple hardcode for EN->VI)
    const LANG_MAP = {
      en: {
        title: "Embroidery Size Checker",
        searchPlaceholder: "Type or paste product name...",
        matrixView: "Matrix view",
        dense: "Dense",
        regexMode: "Regex mode",
        allPositions: "All Positions",
        allSizes: "All Sizes",
        allCosts: "All Costs",
        adminLogin: "Admin login",
        logout: "Logout",
        load: "Load",
        save: "Save",
        delete: "Delete",
        importCSV: "Import CSV",
        selectSize: "Select Size to Add",
        position: "Position (e.g. Middle)",
        cost: "Cost (e.g. 4)",
        addRow: "Add Row",
        hint: "Hint: Each line = one size row...",
        tips: "Tips: Ctrl/⌘+V to paste...",
        footer: "All measurements in millimetres (mm)...",
        recentSearches: "Recent Searches",
        favorites: "Favorites",
        paste: "Paste",
        clear: "Clear",
        print: "Print",
        export: "Export",
        chart: "Chart View",
        favorite: "Favorite",
        unfavorite: "Unfavorite",
        noMatch: "No match found.",
        loginReq: "Login required",
        wrongCred: "Wrong credentials",
        productReq: "Product name required",
        nothingSave: "Nothing to save. Fill some lines.",
        chooseValid: "Choose a valid product",
        saved: "Saved.",
        deleted: "Deleted.",
        duplicateSizes: "Duplicate sizes detected!",
        selectSize: "Select a size",
        clipboardDenied: "Clipboard permission denied. Use Ctrl/⌘+V."
      },
      vi: {
        title: "Công Cụ Kiểm Tra Kích Thước Thêu",
        searchPlaceholder: "Nhập hoặc dán tên sản phẩm...",
        matrixView: "Chế độ Ma Trận",
        dense: "Mật Độ",
        regexMode: "Chế Độ Regex",
        allPositions: "Tất Cả Vị Trí",
        allSizes: "Tất Cả Kích Cỡ",
        allCosts: "Tất Cả Chi Phí",
        adminLogin: "Đăng Nhập Admin",
        logout: "Đăng Xuất",
        load: "Tải",
        save: "Lưu",
        delete: "Xóa",
        importCSV: "Nhập CSV",
        selectSize: "Chọn Kích Cỡ Để Thêm",
        position: "Vị Trí (vd. Middle)",
        cost: "Chi Phí (vd. 4)",
        addRow: "Thêm Hàng",
        hint: "Gợi Ý: Mỗi dòng = một hàng kích cỡ...",
        tips: "Mẹo: Ctrl/⌘+V để dán...",
        footer: "Tất cả đo lường tính bằng milimet (mm)...",
        recentSearches: "Tìm Kiếm Gần Đây",
        favorites: "Yêu Thích",
        paste: "Dán",
        clear: "Xóa",
        print: "In",
        export: "Xuất",
        chart: "Xem Biểu Đồ",
        favorite: "Yêu Thích",
        unfavorite: "Bỏ Yêu Thích",
        noMatch: "Không tìm thấy kết quả.",
        loginReq: "Cần đăng nhập",
        wrongCred: "Thông tin đăng nhập sai",
        productReq: "Cần tên sản phẩm",
        nothingSave: "Không có gì để lưu. Điền một số dòng.",
        chooseValid: "Chọn sản phẩm hợp lệ",
        saved: "Đã lưu.",
        deleted: "Đã xóa.",
        duplicateSizes: "Phát hiện kích cỡ trùng lặp!",
        selectSize: "Chọn kích cỡ",
        clipboardDenied: "Quyền clipboard bị từ chối. Sử dụng Ctrl/⌘+V."
      }
    };

    const LS_KEY = 'embroidery_data_v1';
    const LS_ADMIN = 'embroidery_admin_logged';
    // NEW: LS for history, favorites, theme, lang
    const LS_HISTORY = 'embroidery_history';
    const LS_FAVS = 'embroidery_favs';
    const LS_THEME = 'embroidery_theme';
    const LS_LANG = 'embroidery_lang';

    function loadData(){
      const s = localStorage.getItem(LS_KEY);
      try{ return s? JSON.parse(s) : JSON.parse(JSON.stringify(SEED)); }
      catch(e){ console.warn('Bad data in LS, reset.'); return JSON.parse(JSON.stringify(SEED)); }
    }
    function saveData(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

    let DATA = loadData();
    let currentLang = 'en';
    let chartInstance = null;

    // ===== Auth =====
    function isLogged(){ return localStorage.getItem(LS_ADMIN)==='1'; }
    function login(u,p){ if(u==='1' && p==='1'){ localStorage.setItem(LS_ADMIN,'1'); return true;} return false; }
    function logout(){ localStorage.removeItem(LS_ADMIN); }

    // ===== UI Elements =====
    const elQ=document.getElementById('q');
    const elResults=document.getElementById('results');
    const elChips=document.getElementById('chips');
    const elModeBadge=document.getElementById('modeBadge');
    const elSuggestions = document.getElementById('suggestions');
    const elHistory = document.getElementById('history');
    const elFavChips = document.getElementById('favChips');
    const elProgress = document.getElementById('progress');
    const elProgressBar = document.getElementById('progressBar');

    // NEW: Filters
    const elFilterPos = document.getElementById('filterPos');
    const elFilterSize = document.getElementById('filterSize');
    const elFilterCost = document.getElementById('filterCost');

    const elAdminBar=document.getElementById('adminBar');
    const elAdminName=document.getElementById('adminProductName');
    const elAdminExisting=document.getElementById('adminExisting');
    const elAdminEditor=document.getElementById('adminEditor');

    // NEW: Lang
    const elLangSelect = document.getElementById('langSelect');
    function loadLang() {
      currentLang = localStorage.getItem(LS_LANG) || 'en';
      elLangSelect.value = currentLang;
      updateUIText();
    }
    function updateUIText() {
      const texts = LANG_MAP[currentLang];
      document.querySelector('h1').textContent = texts.title;
      elQ.placeholder = texts.searchPlaceholder;
      // Update other elements (add more as needed)
      // e.g. document.getElementById('btnLogin').textContent = texts.adminLogin;
    }
    elLangSelect.addEventListener('change', (e) => {
      currentLang = e.target.value;
      localStorage.setItem(LS_LANG, currentLang);
      updateUIText();
      doSearch(); // Re-render with new lang
    });

    // NEW: Theme
    function loadTheme() {
      const theme = localStorage.getItem(LS_THEME) || 'dark';
      document.documentElement.classList.toggle('light', theme === 'light');
      document.getElementById('themeToggle').className = theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
    }
    document.getElementById('themeToggle').addEventListener('click', () => {
      const isLight = document.documentElement.classList.toggle('light');
      localStorage.setItem(LS_THEME, isLight ? 'light' : 'dark');
      document.getElementById('themeToggle').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    });

    function refreshAuthUI(){
      const logged=isLogged();
      elAdminBar.classList.toggle('active', logged);
      document.getElementById('btnLogout').style.display = logged? 'inline-block':'none';
      document.getElementById('btnLogin').style.display = logged? 'none':'inline-block';
      elModeBadge.innerHTML = logged? '· <span class="badge">Admin</span>' : '';
      // update product dropdown
      elAdminExisting.innerHTML = Object.keys(DATA).sort((a,b)=>a.localeCompare(b)).map(n=>`<option value="${n}">${n}</option>`).join('');
      loadTheme();
      loadLang();
    }

    // Simple login prompt
    document.getElementById('btnLogin').addEventListener('click',()=>{
      const u = prompt('Username:');
      const p = prompt('Password:');
      if(login(u||'', p||'')) refreshAuthUI(); else alert('Wrong credentials');
    });
    document.getElementById('btnLogout').addEventListener('click',()=>{ logout(); refreshAuthUI(); });

    // NEW: History & Favorites
    let history = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
    let favorites = JSON.parse(localStorage.getItem(LS_FAVS) || '[]');

    function renderHistory() {
      if (history.length === 0) return elHistory.style.display = 'none';
      elHistory.innerHTML = '<div class="sub">Recent Searches:</div><div class="chips">';
      history.slice(0,5).forEach(h => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = h;
        chip.addEventListener('click', () => { elQ.value = h; doSearch(); });
        elHistory.querySelector('.chips').appendChild(chip);
      });
      elHistory.querySelector('.chips').innerHTML += '</div>';
      elHistory.style.display = 'block';
    }

    function addToHistory(query) {
      history = history.filter(h => h !== query).slice(0,9);
      history.unshift(query);
      localStorage.setItem(LS_HISTORY, JSON.stringify(history));
      renderHistory();
    }

    function renderFavorites() {
      if (favorites.length === 0) return elFavChips.parentElement.style.display = 'none';
      elFavChips.innerHTML = '';
      favorites.forEach(fav => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = fav;
        chip.addEventListener('click', () => { elQ.value = fav; doSearch(); });
        elFavChips.appendChild(chip);
      });
      elFavChips.parentElement.style.display = 'block';
    }

    function toggleFavorite(product) {
      const idx = favorites.indexOf(product);
      if (idx > -1) favorites.splice(idx, 1);
      else favorites.unshift(product);
      localStorage.setItem(LS_FAVS, JSON.stringify(favorites));
      renderFavorites();
    }

    // ===== Search / Render =====
    function keyIndex(){ return Object.keys(DATA).map(k=>({key:k, norm:norm(k)})); }

    // NEW: Regex support
    function fuzzyFind(query){
      const n = norm(query); if(!n) return [];
      const idx = keyIndex();
      const isRegex = document.getElementById('toggleRegex').checked;
      let scored;
      if (isRegex) {
        try {
          const regex = new RegExp(query, 'i');
          scored = idx.filter(({key}) => regex.test(key)).map(keyObj => ({key: keyObj.key, score: 100}));
        } catch { scored = []; }
      } else {
        scored = idx.map(({key, norm:kn})=>{
          let score=0;
          if(kn===n) score=100; else if(kn.includes(n)) score=80 - Math.max(0, kn.length-n.length);
          else { const qTokens=n.split(' '), kTokens=kn.split(' '); const overlap=qTokens.filter(t=>kTokens.includes(t)).length; score=overlap*10; }
          return {key, score};
        }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
      }
      return scored.slice(0,8).map(x=>x.key);
    }

    // NEW: Autocomplete
    function renderAutocomplete() {
      const cands = fuzzyFind(elQ.value);
      elSuggestions.innerHTML = cands.slice(0,5).map(cand => `<div onclick="elQ.value='${cand}'; doSearch(); elSuggestions.style.display='none';">${cand}</div>`).join('');
      elSuggestions.style.display = cands.length ? 'block' : 'none';
    }
    elQ.addEventListener('input', (e) => {
      renderAutocomplete();
    });
    document.addEventListener('click', (e) => { if (!elQ.contains(e.target)) elSuggestions.style.display = 'none'; });

    function chipEl(label){
      const c=document.createElement('button'); c.className='chip'; c.textContent=label; c.dataset.size=label;
      c.addEventListener('click',()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active');
        filterRows(label);
      });
      return c;
    }

    function renderChips(sizes){
      elChips.innerHTML=''; if(!sizes.length) return;
      const all=chipEl('All'); all.classList.add('active'); elChips.appendChild(all);
      sizes.sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric:true})).forEach(s=>elChips.appendChild(chipEl(s)));
    }

    function filterRows(size){
      document.querySelectorAll('tbody tr').forEach(tr=>{ tr.style.display = (size==='All' || tr.dataset.size===size)?'':'none'; });
    }

    // NEW: Advanced filter (simplified)
    function applyFilters() {
      const pos = elFilterPos.value;
      const size = elFilterSize.value;
      const cost = elFilterCost.value;
      document.querySelectorAll('.card').forEach(card => {
        let show = true;
        const text = card.textContent.toLowerCase();
        if (pos && !text.includes(pos.toLowerCase())) show = false;
        if (size && !text.includes(size.toLowerCase())) show = false;
        if (cost && !text.includes(cost.toLowerCase())) show = false;
        card.style.display = show ? '' : 'none';
      });
    }
    [elFilterPos, elFilterSize, elFilterCost].forEach(el => el.addEventListener('change', applyFilters));

    let useChart = false;
    document.getElementById('btnChart').addEventListener('click', () => {
      useChart = !useChart;
      doSearch();
    });

    function render(productName, rows){
      // Show progress
      elProgress.style.display = 'block';
      elProgressBar.style.width = '0%';
      setTimeout(() => { elProgressBar.style.width = '100%'; }, 50);
      setTimeout(() => { elProgress.style.display = 'none'; }, 500);

      elResults.innerHTML = '';
      const header=document.createElement('div'); header.className='card';
      header.innerHTML = `<h3>${productName}</h3><div class="meta">Positions & maximum embroidery areas (mm)</div>`;
      elResults.appendChild(header);

      // NEW: Favorite button
      const favBtn = document.createElement('button');
      favBtn.className = 'btn ok';
      favBtn.innerHTML = favorites.includes(productName) ? '<i class="fas fa-star"></i> Unfavorite' : '<i class="fas fa-star"></i> Favorite';
      favBtn.addEventListener('click', () => toggleFavorite(productName));
      header.appendChild(favBtn);

      // collect unique sizes
      const sizeSet=new Set(); rows.forEach(b=>b.rows.forEach(r=>sizeSet.add(r.size))); const sizes=[...sizeSet];
      renderChips(sizes);

      // NEW: Update filters
      const allPos = [...new Set(rows.map(b => b.position))];
      elFilterPos.innerHTML = '<option value="">All Positions</option>' + allPos.map(p => `<option value="${p}">${p}</option>`).join('');
      const allSizes = sizes;
      elFilterSize.innerHTML = '<option value="">All Sizes</option>' + allSizes.map(s => `<option value="${s}">${s}</option>`).join('');
      const allCosts = [...new Set(rows.map(b => b.cost))];
      elFilterCost.innerHTML = '<option value="">All Costs</option>' + allCosts.map(c => `<option value="${c}">${c}</option>`).join('');

      const useMatrix=document.getElementById('toggleMatrix').checked;
      const dense=document.getElementById('toggleDense').checked;

      // NEW: Visual Size Chart
      if (useChart) {
        const card = document.createElement('div'); card.className = 'card';
        const canvas = document.createElement('canvas'); canvas.id = 'chartCanvas';
        card.appendChild(canvas);
        elResults.appendChild(card);
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sizes,
            datasets: [{
              label: 'Max Height (mm)',
              data: sizes.map(s => {
                const avg = rows.flatMap(b => b.rows.filter(r => r.size === s)).reduce((sum, r) => sum + r.maxH, 0) / Math.max(1, rows.flatMap(b => b.rows.filter(r => r.size === s)).length);
                return avg || 0;
              }),
              backgroundColor: 'rgba(101, 183, 255, 0.6)'
            }, {
              label: 'Max Width (mm)',
              data: sizes.map(s => {
                const avg = rows.flatMap(b => b.rows.filter(r => r.size === s)).reduce((sum, r) => sum + r.maxW, 0) / Math.max(1, rows.flatMap(b => b.rows.filter(r => r.size === s)).length);
                return avg || 0;
              }),
              backgroundColor: 'rgba(46, 204, 113, 0.6)'
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
        return;
      }

      if(useMatrix){
        const card=document.createElement('div'); card.className='card';
        const wrap=document.createElement('div'); wrap.className='table-wrap';
        const tbl=document.createElement('table'); tbl.className='sticky'; if(dense) tbl.classList.add('dense');
        const thead=document.createElement('thead'); const hr=document.createElement('tr');
        hr.innerHTML = `<th>Position</th><th>Cost</th>` + sizes.map(s=>`<th>${s}</th>`).join(''); thead.appendChild(hr); tbl.appendChild(thead);
        const tb=document.createElement('tbody');
        rows.forEach(block=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${block.position}</td><td>${block.cost}</td>` + sizes.map(s=>{
            const m=block.rows.find(r=>r.size===s); return `<td>${m? `${m.maxH}×${m.maxW}`:'–'}</td>`;
          }).join('');
          tb.appendChild(tr);
        });
        tbl.appendChild(tb); wrap.appendChild(tbl); card.appendChild(wrap); elResults.appendChild(card);

        // NEW: Sortable & searchable
        const theadTr = tbl.querySelector('thead tr');
        Array.from(theadTr.children).forEach((th, idx) => {
          th.style.cursor = 'pointer';
          th.addEventListener('click', () => sortTable(idx, tb));
        });
        const searchTh = theadTr.children[0];
        const searchInput = document.createElement('input');
        searchInput.className = 'table-search';
        searchInput.placeholder = 'Search rows...';
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          Array.from(tb.children).forEach(tr => {
            tr.style.display = Array.from(tr.children).some(td => td.textContent.toLowerCase().includes(term)) ? '' : 'none';
          });
        });
        searchTh.innerHTML = '';
        searchTh.appendChild(searchInput);
        Array.from(theadTr.children).forEach((th, idx) => {
          if (idx > 0) th.innerHTML = `<i class="fas fa-sort"></i> ${th.textContent}`;
        });
        return;
      }

      // Non-matrix: each position -> table of rows
      rows.forEach(block=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `<div class="meta">${block.position} <span class="pill">Cost: ${block.cost}</span></div>`;
        const wrap=document.createElement('div'); wrap.className='table-wrap';
        const tbl=document.createElement('table'); tbl.className='sticky'; if(dense) tbl.classList.add('dense');
        tbl.innerHTML = `<thead><tr><th>Size</th><th>Max Height (mm)</th><th>Max Width (mm)</th></tr></thead>`;
        const tb=document.createElement('tbody');
        block.rows.forEach(r=>{ const tr=document.createElement('tr'); tr.dataset.size=r.size; tr.innerHTML = `<td>${r.size}</td><td>${r.maxH}</td><td>${r.maxW}</td>`; tb.appendChild(tr); });
        tbl.appendChild(tb); wrap.appendChild(tbl); card.appendChild(wrap); elResults.appendChild(card);
      });

      addToHistory(productName);
      renderHistory();
      renderFavorites();
      applyFilters();
    }

    function sortTable(colIdx, tbody) {
      const rows = Array.from(tbody.children);
      rows.sort((a, b) => {
        let aVal = a.children[colIdx].textContent;
        let bVal = b.children[colIdx].textContent;
        if (colIdx >= 2) { // Numeric for H/W
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
          return aVal - bVal;
        }
        return aVal.localeCompare(bVal);
      });
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    }

    function doSearch(){
      const q=elQ.value.trim();
      if(!q){ elResults.innerHTML='<div class="meta">Type or paste a product name.</div>'; elChips.innerHTML=''; return; }
      const exact=Object.keys(DATA).find(k=>norm(k)===norm(q));
      const cands = exact? [exact] : fuzzyFind(q);
      const chosen = exact || cands[0];
      if(!chosen){ elResults.innerHTML='<div class="meta danger">No match found.</div>'; elChips.innerHTML=''; return; }
      render(chosen, DATA[chosen]);
    }

    // ===== Admin: parse/save =====
    function parseEditor(text){
      // Lines: Position | Cost | Size | H | W
      const lines=(text||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const buckets=new Map(); // key: position||cost -> {position,cost, rows:[]}
      for(const line of lines){
        const parts=line.split('|').map(x=>x.trim());
        if(parts.length<5) continue;
        const [pos, costStr, size, hStr, wStr]=parts;
        const cost = (isNaN(Number(costStr))? costStr : (Number(costStr)||costStr));
        const maxH = Number(hStr); const maxW = Number(wStr);
        if(!pos || !size || !maxH || !maxW) continue;
        const key=`${pos}__${cost}`;
        if(!buckets.has(key)) buckets.set(key, {position:pos, cost:cost, rows:[]});
        buckets.get(key).rows.push({size, maxH, maxW});
      }
      return [...buckets.values()];
    }

    function loadToEditor(name){
      const blocks = DATA[name]; if(!blocks){ elAdminEditor.value=''; return; }
      const lines=[];
      blocks.forEach(b=> b.rows.forEach(r=> lines.push(`${b.position} | ${b.cost} | ${r.size} | ${r.maxH} | ${r.maxW}`)) );
      elAdminEditor.value = lines.join('\n');
    }

    document.getElementById('btnLoad').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const sel=elAdminExisting.value; elAdminName.value=sel; loadToEditor(sel);
    });

    document.getElementById('btnSave').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const name=(elAdminName.value||'').trim(); if(!name) return alert('Product name required');
      const blocks=parseEditor(elAdminEditor.value);
      if(!blocks.length) return alert('Nothing to save. Fill some lines.');
      // NEW: Validate dups
      let hasDup = false;
      blocks.forEach(b => {
        const sizes = b.rows.map(r => r.size);
        if (new Set(sizes).size < sizes.length) hasDup = true;
      });
      if (hasDup) return alert('Duplicate sizes detected!');
      DATA[name]=blocks; saveData(DATA); refreshAuthUI(); alert('Saved.'); doSearch();
    });

    document.getElementById('btnDelete').addEventListener('click',()=>{
      if(!isLogged()) return alert('Login required');
      const name=(elAdminName.value||'').trim() || elAdminExisting.value;
      if(!name || !DATA[name]) return alert('Choose a valid product');
      if(confirm(`Delete product "${name}"?`)) { delete DATA[name]; saveData(DATA); refreshAuthUI(); elAdminEditor.value=''; elAdminName.value=''; alert('Deleted.'); doSearch(); }
    });

    // NEW: Bulk Import
    document.getElementById('importFile').addEventListener('change', (e) => {
      if (!isLogged()) return alert('Login required');
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: (results) => {
          results.data.forEach(row => {
            if (row.product && row.position && row.cost && row.size && row.maxH && row.maxW) {
              const key = `${row.position}__${row.cost}`;
              if (!DATA[row.product]) DATA[row.product] = [];
              // Find or create block
              let block = DATA[row.product].find(b => b.position === row.position && b.cost === row.cost);
              if (!block) {
                block = {position: row.position, cost: row.cost, rows: []};
                DATA[row.product].push(block);
              }
              block.rows.push({size: row.size, maxH: Number(row.maxH), maxW: Number(row.maxW)});
            }
          });
          saveData(DATA);
          alert('Imported successfully!');
          refreshAuthUI();
        }
      });
    });

    // NEW: Quick Add with Auto-Suggest
    const elQuickSize = document.getElementById('quickSizeSelect');
    const elQuickPos = document.getElementById('quickPos');
    const elQuickCost = document.getElementById('quickCost');
    const elSuggestPreview = document.getElementById('suggestPreview');
    [elQuickSize, elQuickPos].forEach(el => el.addEventListener('change', () => {
      const size = elQuickSize.value;
      const pos = elQuickPos.value;
      if (size && pos) {
        const suggest = SUGGEST_MAP[`${pos}_${size}`];
        if (suggest) {
          elSuggestPreview.textContent = `Suggested: ${suggest.h} x ${suggest.w} mm`;
          elSuggestPreview.style.display = 'block';
        } else {
          elSuggestPreview.style.display = 'none';
        }
      }
    }));
    document.getElementById('btnAddRow').addEventListener('click', () => {
      const size = elQuickSize.value;
      const pos = elQuickPos.value || 'Middle';
      const cost = elQuickCost.value || '4';
      if (!size) return alert('Select a size');
      const suggest = SUGGEST_MAP[`${pos}_${size}`];
      const h = suggest ? suggest.h : 195;
      const w = suggest ? suggest.w : 275;
      const line = `${pos} | ${cost} | ${size} | ${h} | ${w}`;
      elAdminEditor.value += '\n' + line;
      elSuggestPreview.style.display = 'none';
    });

    // ===== Export =====
    document.getElementById('btnExport').addEventListener('click', () => {
      const isPDF = confirm('Export as PDF? (Cancel for CSV)');
      const product = elQ.value.trim();
      if (!product || !DATA[product]) return alert('Search a product first');
      const rows = DATA[product];
      const csvContent = 'Position,Cost,Size,MaxH,MaxW\n' + rows.flatMap(b => b.rows.map(r => `${b.position},${b.cost},${r.size},${r.maxH},${r.maxW}`)).join('\n');
      if (!isPDF) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${product}.csv`;
        link.click();
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`${product} Sizes`, 10, 10);
      const tableData = rows.map(b => [b.position, b.cost, ...b.rows.map(r => `${r.size}: ${r.maxH}x${r.maxW}`)]);
      doc.autoTable({ head: [['Position', 'Cost', 'Sizes']], body: tableData });
      doc.save(`${product}.pdf`);
    });

    // ===== Wire up search & clipboard =====
    document.getElementById('btnPaste').addEventListener('click', async()=>{
      try{ const t=await navigator.clipboard.readText(); if(t){ elQ.value=t.trim(); doSearch(); } }
      catch(e){ alert('Clipboard permission denied. Use Ctrl/⌘+V.'); }
    });
    document.getElementById('btnClear').addEventListener('click',()=>{ elQ.value=''; elResults.innerHTML=''; elChips.innerHTML=''; elQ.focus(); });
    document.getElementById('btnPrint').addEventListener('click',()=>window.print());
    document.getElementById('toggleMatrix').addEventListener('change', doSearch);
    document.getElementById('toggleDense').addEventListener('change', doSearch);

    elQ.addEventListener('input', debounce(doSearch, 250));
    elQ.addEventListener('paste', ()=> setTimeout(doSearch, 0));

    // NEW: PWA Offline Mode
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', e => {
          e.waitUntil(caches.open('embroidery-v1').then(cache => cache.addAll(['index.html', './'])));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
        });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(console.error);
    }
    // Prompt install if PWA
    window.addEventListener('beforeinstallprompt', (e) => {
      e.prompt();
    });

    // Init
    refreshAuthUI();
    renderFavorites();
    renderHistory();
    elQ.value='Embroidered Shorts for Women';
    doSearch();
  </script>
</body>
</html>